{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white shadow p-6 rounded relative space-y-5" data-widget-id="admin-threat-detail">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        {% set display_title = threat.title or threat.summary or threat.cve_id or ("Threat " ~ threat.id) %}
        <div>
            <h2 class="text-2xl font-semibold text-slate-900 leading-tight">{{ display_title }}</h2>
            <div class="flex items-center gap-2 mt-1">
                {% if threat.kev_flag %}
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-red-50 text-red-800 border border-red-200">KEV</span>
                {% endif %}
                {% if threat.is_enriched %}
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-800 border border-blue-200">Enriched</span>
                {% endif %}
                {% if threat.badge_updated and not threat.is_enriched %}
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 border border-amber-200">Updated</span>
                {% endif %}
            </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
            {% set b = back_params or {} %}
            <a href="{{ url_for('threats.admin_threats', source=b.get('source',''), q=b.get('q',''), severity=b.get('severity',''), page=b.get('page','')) }}" class="inline-flex items-center px-3 py-2 text-sm font-semibold text-slate-700 bg-slate-100 border border-slate-200 rounded hover:bg-slate-200">
                ← Back to threats
            </a>
        </div>
    </div>

    {% set base_tile_class = 'border rounded p-3 bg-white text-slate-900 border-slate-200' %}
    {% set high_tile_class = 'border rounded p-3 bg-red-50 border-red-200 text-red-900' %}
    {% set medium_tile_class = 'border rounded p-3 bg-amber-50 border-amber-200 text-amber-900' %}
    {% set low_tile_class = 'border rounded p-3 bg-emerald-50 border-emerald-200 text-emerald-900' %}
    {% set sev_val = (threat.severity or '')|lower %}
    {% set severity_tile_class = base_tile_class %}
    {% if 'high' in sev_val or 'critical' in sev_val %}
        {% set severity_tile_class = high_tile_class %}
    {% elif 'medium' in sev_val %}
        {% set severity_tile_class = medium_tile_class %}
    {% elif 'low' in sev_val %}
        {% set severity_tile_class = low_tile_class %}
    {% endif %}
    {% set cvss_score = threat.cvss_base_score %}
    {% set cvss_tile_class = base_tile_class %}
    {% if cvss_score %}
        {% set score_val = (cvss_score|string)|float(0) %}
        {% if score_val >= 7 %}
            {% set cvss_tile_class = high_tile_class %}
        {% elif score_val <= 3.9 %}
            {% set cvss_tile_class = low_tile_class %}
        {% endif %}
    {% endif %}
    {% set cvss_labels = {
        'av': {'N': 'Network', 'A': 'Adjacent', 'L': 'Local', 'P': 'Physical'},
        'ac': {'L': 'Low', 'H': 'High'},
        'pr': {'N': 'None', 'L': 'Low', 'H': 'High'},
        'ui': {'N': 'None', 'R': 'Required'},
        's': {'U': 'Unchanged', 'C': 'Changed'},
        'c': {'N': 'None', 'L': 'Low', 'H': 'High'},
        'i': {'N': 'None', 'L': 'Low', 'H': 'High'},
        'a': {'N': 'None', 'L': 'Low', 'H': 'High'},
    } %}
    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-4" data-widget-id="widget-all-fields">
        <div class="font-semibold text-slate-800 mb-1">All Fields</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">CVE</div>
                <div class="text-inherit font-semibold">{{ threat.cve_id or "—" }}</div>
            </div>
            <div class="{{ severity_tile_class }} text-center">
                <div class="text-xs text-slate-500">Severity</div>
                <div class="text-inherit font-semibold">{{ threat.severity or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Source</div>
                {% set source_label = threat.source or "—" %}
                {% if threat.source and 'nvd' in threat.source|lower %}
                    {% set source_label = source_label ~ ' (Product Family: ' ~ (threat.nvd_product_family or threat.products_text or '—') ~ ')' %}
                {% endif %}
                {% if threat.link %}
                    <a class="text-inherit underline font-semibold" href="{{ threat.link }}" target="_blank" rel="noopener">{{ source_label }}</a>
                {% else %}
                    <div class="text-inherit font-semibold">{{ source_label }}</div>
                {% endif %}
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Published</div>
                <div class="text-inherit font-semibold">{{ threat.published_at_display or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">KEV Flag</div>
                <div class="text-inherit font-semibold">{{ "Yes" if threat.kev_flag else "No" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Type</div>
                <div class="text-inherit font-semibold">{{ threat.item_type or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} md:col-span-3">
                <div class="text-xs text-slate-500 mb-1">Summary</div>
                <div class="whitespace-pre-wrap text-inherit font-semibold">{{ (threat.summary or "—")|striptags }}</div>
            </div>
            <div class="{{ base_tile_class }} md:col-span-3">
                <div class="text-xs text-slate-500">Source</div>
                {% if kev_enrichment and kev_enrichment.kev_source_url %}
                    <a class="text-inherit underline font-semibold" href="{{ kev_enrichment.kev_source_url }}" target="_blank" rel="noopener">{{ kev_enrichment.kev_source_url }}</a>
                {% else %}
                    {% set source_label = threat.source or "—" %}
                    {% if threat.source and 'nvd' in threat.source|lower %}
                        {% set source_label = source_label ~ ' (Product Family: ' ~ (threat.nvd_product_family or threat.products_text or '—') ~ ')' %}
                    {% endif %}
                    {% if threat.link %}
                        <a class="text-inherit underline font-semibold" href="{{ threat.link }}" target="_blank" rel="noopener">{{ source_label }}</a>
                    {% else %}
                        <div class="text-inherit font-semibold">{{ source_label }}</div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-4" data-widget-id="widget-cvss">
        <div class="font-semibold text-slate-800 mb-1">Common Vulnerability Scoring System (CVSS)</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            <div class="{{ cvss_tile_class }} text-center">
                <div class="text-xs text-slate-500">CVSS Base Score</div>
                <div class="text-inherit font-semibold">{{ threat.cvss_base_score or "—" }}</div>
            </div>
            {% set av_class = base_tile_class %}
            <div class="{{ av_class }} text-center">
                <div class="text-xs text-slate-500">Attack Vector (AV)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_av %}
                        {{ threat.cvss_av }} - {{ cvss_labels.av.get(threat.cvss_av, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set ac_class = base_tile_class %}
            {% if threat.cvss_ac %}
                {% if threat.cvss_ac == 'H' %}
                    {% set ac_class = high_tile_class %}
                {% elif threat.cvss_ac == 'L' %}
                    {% set ac_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ ac_class }} text-center">
                <div class="text-xs text-slate-500">Attack Complexity (AC)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_ac %}
                        {{ threat.cvss_ac }} - {{ cvss_labels.ac.get(threat.cvss_ac, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set pr_class = base_tile_class %}
            {% if threat.cvss_pr %}
                {% if threat.cvss_pr == 'H' %}
                    {% set pr_class = low_tile_class %}
                {% elif threat.cvss_pr == 'L' %}
                    {% set pr_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ pr_class }} text-center">
                <div class="text-xs text-slate-500">Privileges Required (PR)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_pr %}
                        {{ threat.cvss_pr }} - {{ cvss_labels.pr.get(threat.cvss_pr, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set ui_class = base_tile_class %}
            {% if threat.cvss_ui %}
                {% if threat.cvss_ui == 'R' %}
                    {% set ui_class = high_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ ui_class }} text-center">
                <div class="text-xs text-slate-500">User Interaction (UI)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_ui %}
                        {{ threat.cvss_ui }} - {{ cvss_labels.ui.get(threat.cvss_ui, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set s_class = base_tile_class %}
            {% if threat.cvss_s %}
                {% if threat.cvss_s == 'C' %}
                    {% set s_class = high_tile_class %}
                {% elif threat.cvss_s == 'U' %}
                    {% set s_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ s_class }} text-center">
                <div class="text-xs text-slate-500">Scope (S)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_s %}
                        {{ threat.cvss_s }} - {{ cvss_labels.s.get(threat.cvss_s, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set c_class = base_tile_class %}
            {% if threat.cvss_c %}
                {% if threat.cvss_c == 'H' %}
                    {% set c_class = high_tile_class %}
                {% elif threat.cvss_c == 'L' %}
                    {% set c_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ c_class }} text-center">
                <div class="text-xs text-slate-500">Confidentiality (C)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_c %}
                        {{ threat.cvss_c }} - {{ cvss_labels.c.get(threat.cvss_c, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set i_class = base_tile_class %}
            {% if threat.cvss_i %}
                {% if threat.cvss_i == 'H' %}
                    {% set i_class = high_tile_class %}
                {% elif threat.cvss_i == 'L' %}
                    {% set i_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ i_class }} text-center">
                <div class="text-xs text-slate-500">Integrity (I)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_i %}
                        {{ threat.cvss_i }} - {{ cvss_labels.i.get(threat.cvss_i, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
            {% set a_class = base_tile_class %}
            {% if threat.cvss_a %}
                {% if threat.cvss_a == 'H' %}
                    {% set a_class = high_tile_class %}
                {% elif threat.cvss_a == 'L' %}
                    {% set a_class = low_tile_class %}
                {% endif %}
            {% endif %}
            <div class="{{ a_class }} text-center">
                <div class="text-xs text-slate-500">Availability (A)</div>
                <div class="text-inherit font-semibold">
                    {% if threat.cvss_a %}
                        {{ threat.cvss_a }} - {{ cvss_labels.a.get(threat.cvss_a, '') }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if kev_enrichment %}
    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-4" data-widget-id="widget-kev">
        <div class="font-semibold text-slate-800 mb-1">Cybersecurity and Infrastructure Security Agency - Known Exploited Vulnerabilities</div>
        {% set act_yes = kev_enrichment.kev_action_required not in [None, 0, '0', False, 'false', 'False'] %}
        {% set exploited = kev_enrichment.known_exploited not in [None, 0, '0', False, 'false', 'False'] %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Date Added</div>
                <div class="text-inherit font-semibold">{{ kev_enrichment.date_added_display or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Due Date</div>
                <div class="text-inherit font-semibold">{{ kev_enrichment.due_date_display or "—" }}</div>
            </div>
            {% set act_class = 'border rounded p-3 text-center bg-red-50 border-red-200 text-red-900' if act_yes else base_tile_class + ' text-center' %}
            <div class="{{ act_class }}">
                <div class="text-xs text-slate-500">Action Required</div>
                <div class="{% if act_yes %}text-red-900 font-semibold{% else %}text-inherit font-semibold{% endif %}">{{ "Yes" if act_yes else "No" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Vendor</div>
                <div class="text-inherit font-semibold">{{ kev_enrichment.kev_vendor or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Product</div>
                <div class="text-inherit font-semibold">{{ kev_enrichment.kev_product or "—" }}</div>
            </div>
            {% set exp_class = 'border rounded p-3 text-center bg-red-50 border-red-200 text-red-900' if exploited else base_tile_class + ' text-center' %}
            <div class="{{ exp_class }}">
                <div class="text-xs text-slate-500">Known Exploited</div>
                <div class="{% if exploited %}text-red-900 font-semibold{% else %}text-inherit font-semibold{% endif %}">{{ "Yes" if exploited else "No" }}</div>
            </div>
            <div class="{{ base_tile_class }} md:col-span-3 text-left">
                <div class="text-xs text-slate-500 mb-1">Description</div>
                <div class="whitespace-pre-wrap text-inherit font-semibold">{{ kev_enrichment.kev_description or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} md:col-span-3 text-left">
                <div class="text-xs text-slate-500 mb-1">requiredAction</div>
                <div class="whitespace-pre-wrap text-inherit font-semibold">{{ kev_enrichment.kev_action_required_text or "—" }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if msrc_enrichment %}
    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-4" data-widget-id="widget-msrc">
        <div class="font-semibold text-slate-800 mb-1">Microsoft Security Response Centre (MSRC)</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            {% set release_display = msrc_enrichment.msrc_release_title or msrc_enrichment.msrc_release_id %}
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Release</div>
                <div class="text-inherit font-semibold truncate" title="{{ release_display or '—' }}">
                    {{ release_display or '—' }}
                </div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Updated</div>
                <div class="text-inherit font-semibold">{{ msrc_enrichment.current_display or "—" }}</div>
            </div>
            {% set car = msrc_enrichment.msrc_customer_action_required %}
            {% set car_class = high_tile_class if car else low_tile_class %}
            <div class="{{ car_class }} text-center">
                <div class="text-xs text-slate-500">Action required</div>
                <div class="text-inherit font-semibold">{{ "Yes" if car else "No" }}</div>
            </div>
            {% set exp = msrc_enrichment.msrc_exploited %}
            {% set exp_class = high_tile_class if exp else low_tile_class %}
            <div class="{{ exp_class }} text-center">
                <div class="text-xs text-slate-500">Exploited</div>
                <div class="text-inherit font-semibold">{{ "Yes" if exp else "No" }}</div>
            </div>
            {% set pub = msrc_enrichment.msrc_publicly_disclosed %}
            {% set pub_class = high_tile_class if pub else low_tile_class %}
            <div class="{{ pub_class }} text-center">
                <div class="text-xs text-slate-500">Publicly disclosed</div>
                <div class="text-inherit font-semibold">{{ "Yes" if pub else "No" }}</div>
            </div>
            {% if msrc_enrichment.msrc_latest_release %}
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Latest software release</div>
                <div class="text-inherit font-semibold whitespace-pre-wrap">{{ msrc_enrichment.msrc_latest_release }}</div>
            </div>
            {% endif %}
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Fixed build</div>
                <div class="text-inherit font-semibold">{{ msrc_enrichment.msrc_fixed_build or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">CVSS Base</div>
                <div class="text-inherit font-semibold">{{ msrc_enrichment.msrc_cvss_base_score or "—" }}</div>
            </div>
            <div class="{{ base_tile_class }} text-center">
                <div class="text-xs text-slate-500">Remediation</div>
                {% set urls = msrc_enrichment.remediation_urls_list or [] %}
                {% if urls %}
                    <a class="text-blue-700 underline font-semibold truncate inline-block max-w-full" href="{{ urls[0] }}" title="{{ urls[0] }}" target="_blank" rel="noopener">{{ urls[0] }}</a>
                {% else %}
                    <div class="text-inherit font-semibold">—</div>
                {% endif %}
            </div>
            <div class="{{ base_tile_class }} md:col-span-3 text-left">
                <div class="text-xs text-slate-500 mb-1">Description</div>
                <div class="whitespace-pre-wrap line-clamp-2 font-semibold">{{ msrc_enrichment.msrc_summary_text or "—" }}</div>
                {% if msrc_enrichment.msrc_summary_text %}
                    <details class="text-[11px] text-blue-700 mt-1">
                        <summary class="cursor-pointer">Expand</summary>
                        <div class="whitespace-pre-wrap text-slate-700 mt-1">{{ msrc_enrichment.msrc_summary_text }}</div>
                    </details>
                {% endif %}
            </div>
            <div class="{{ base_tile_class }} md:col-span-3 text-left">
                <details class="text-xs text-slate-700">
                    <summary class="cursor-pointer text-sm text-blue-700">More details</summary>
                    <div class="space-y-2 mt-1">
                        <div class="text-xs text-slate-600">CVSS Vector: {{ msrc_enrichment.msrc_cvss_vector or "—" }}</div>
                        <div class="text-xs text-slate-600">Affected products:
                            {% if msrc_enrichment.products_list %}
                                <ul class="list-disc list-inside">
                                    {% for p in msrc_enrichment.products_list %}
                                        <li>{{ p }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                —
                            {% endif %}
                        </div>
                        <div class="text-xs text-slate-600">Remediation URLs:
                            {% if urls %}
                                <ul class="list-disc list-inside">
                                    {% for u in urls %}
                                        <li><a class="text-blue-700 underline" href="{{ u }}" target="_blank" rel="noopener">{{ u }}</a></li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                —
                            {% endif %}
                        </div>
                        {% if msrc_enrichment.msrc_cvrf_url %}
                        <div class="text-xs text-slate-600">CVRF: <a class="text-blue-700 underline" href="{{ msrc_enrichment.msrc_cvrf_url }}" target="_blank" rel="noopener">{{ msrc_enrichment.msrc_cvrf_url }}</a></div>
                        {% endif %}
                    </div>
                </details>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-4" data-widget-id="widget-products">
        <div class="font-semibold text-slate-800 mb-1">Products</div>
        <div class="{{ base_tile_class }}">
            <div class="text-xs text-slate-500">Products</div>
            <div class="whitespace-pre-wrap text-inherit">{{ threat.products_text or "—" }}</div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" data-widget-id="widget-raw-history">
        <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-3">
            <div class="font-semibold text-slate-800 mb-1">Raw / Full Data</div>
            <details class="text-xs text-slate-700">
                <summary class="cursor-pointer text-sm text-blue-700">Show all fields (full dump)</summary>
                <div class="space-y-1 mt-2 max-h-[400px] overflow-auto pr-2">
                    <div class="grid grid-cols-[160px,1fr] gap-2 items-start border-b border-slate-100 pb-1">
                        <div class="font-semibold">products_text</div>
                        <div class="whitespace-pre-wrap break-words">{{ threat.products_text }}</div>
                    </div>
                    <div class="grid grid-cols-[160px,1fr] gap-2 items-start border-b border-slate-100 pb-1">
                        <div class="font-semibold">nvd_product_family</div>
                        <div class="whitespace-pre-wrap break-words">{{ threat.nvd_product_family }}</div>
                    </div>
                    {% for k, v in threat.items() %}
                        <div class="grid grid-cols-[160px,1fr] gap-2 items-start border-b border-slate-100 pb-1">
                            <div class="font-semibold">{{ k }}</div>
                            <div class="whitespace-pre-wrap break-words">{{ v }}</div>
                        </div>
                    {% endfor %}
                </div>
            </details>
            <details class="text-xs text-slate-700">
                <summary class="cursor-pointer text-sm text-blue-700">Show raw_payload</summary>
                <pre class="text-xs bg-white border border-slate-200 rounded p-3 overflow-x-auto whitespace-pre-wrap mt-2 max-h-[400px]">{{ threat.raw_payload }}</pre>
            </details>
        </div>
        <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-3">
            <div class="font-semibold text-slate-800 mb-1">Change History</div>
            {% if history %}
                <div class="space-y-2 max-h-[400px] overflow-auto pr-2">
                    {% for h in history %}
                        <div class="border border-slate-100 rounded p-2 bg-white">
                            <div class="text-[11px] text-slate-600 flex flex-wrap gap-2 items-center">
                                <span class="whitespace-nowrap font-semibold">{{ h.source }}</span>
                                <span class="whitespace-nowrap">• {{ h.action }}</span>
                                <span class="whitespace-nowrap">• {{ h.created_at_display or h.created_at }}</span>
                                <span class="whitespace-pre-wrap break-words">• Changed: {{ h.changed_fields or '—' }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-xs text-slate-600">No history recorded for this CVE yet.</div>
            {% endif %}
        </div>
    </div>

    <div class="bg-slate-50 border border-slate-100 rounded p-4 text-sm text-slate-700 space-y-3" data-widget-id="widget-secondary-sources">
        <div class="flex items-center justify-between">
            <div class="font-semibold text-slate-800">Secondary Sources</div>
            {% if threat.cve_id %}
            <form method="POST" action="/admin/threats/{{ threat.id }}/apply_feeds">
                <button class="bg-blue-600 text-white px-3 py-2 rounded text-sm" type="submit">Re-apply enrichment</button>
            </form>
            {% endif %}
        </div>
        {% if feed_entries %}
        <div class="space-y-2">
            {% for entry in feed_entries %}
            <div class="border border-slate-200 rounded p-2 bg-white text-xs">
                <div class="flex items-center justify-between">
                    <div class="font-semibold text-slate-800">{{ entry.source }} • {{ entry.fetched_at or '—' }}</div>
                    {% if entry.status %}
                    <span class="text-[11px] px-1.5 py-0.5 rounded-full bg-slate-50 text-slate-700 border border-slate-200">{{ entry.status }}</span>
                    {% endif %}
                </div>
                <div class="text-slate-700">Products: {{ entry.products_text or '—' }}</div>
                <div class="text-slate-700">KEV: {{ 'Yes' if entry.kev_flag else 'No' }}</div>
                <details class="mt-1">
                    <summary class="cursor-pointer text-blue-700">View raw payload</summary>
                    <pre class="bg-slate-50 border border-slate-200 rounded p-2 mt-1 whitespace-pre-wrap overflow-auto max-h-[240px]">{{ entry.raw_payload }}</pre>
                </details>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-xs text-slate-600">No secondary feed data captured for this CVE yet.</div>
        {% endif %}
    </div>

    {% if is_msrc %}
    <div id="msrcModal" class="fixed inset-0 bg-slate-900/40 hidden z-50 overflow-y-auto">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-white rounded shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 sticky top-0 bg-white">
                    <div class="font-semibold text-slate-800 text-sm">MSRC CVRF Details</div>
                    <button id="msrcClose" class="text-slate-500 hover:text-slate-700 text-sm">✕</button>
                </div>
                <div class="p-4 overflow-y-auto text-xs font-mono whitespace-pre-wrap max-h-[85vh]" id="msrcContent"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if is_msrc %}
<script>
(function() {
    const btn = document.getElementById("btn-msrc-details");
    const modal = document.getElementById("msrcModal");
    const closeBtn = document.getElementById("msrcClose");
    const content = document.getElementById("msrcContent");
    function pickTable(html) {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const tables = Array.from(doc.querySelectorAll("table"));
            if (!tables.length) return null;
            // choose the table with the most columns (then most rows)
            let best = null;
            let bestScore = -1;
            tables.forEach(t => {
                const headerCells = Array.from(t.querySelectorAll("thead th, thead td"));
                const bodyRows = Array.from(t.querySelectorAll("tbody tr"));
                let rows = bodyRows;
                let headers = headerCells.map(c => c.textContent.trim());
                if (!headers.length) {
                    const allRows = Array.from(t.querySelectorAll("tr"));
                    if (allRows.length) {
                        headers = Array.from(allRows[0].querySelectorAll("th,td")).map(c => c.textContent.trim());
                        rows = allRows.slice(1);
                    }
                }
                const rowData = rows.map(r => Array.from(r.querySelectorAll("td")).map(c => c.textContent.trim()));
                const colCount = Math.max(headers.length, ...(rowData.map(r => r.length)));
                const score = colCount * 1000 + rowData.length; // prioritize columns, then rows
                if (score > bestScore) {
                    bestScore = score;
                    best = { headers, rows: rowData };
                }
            });
            return best;
        } catch (e) {
            return null;
        }
    }
    function hide() { modal.classList.add("hidden"); }
    function show() { modal.classList.remove("hidden"); }
    btn?.addEventListener("click", async () => {
        content.innerHTML = "<div class='text-slate-600'>Loading...</div>";
        show();
        try {
            const cve = btn.dataset.cve;
            const res = await fetch(`/admin/threats/${encodeURIComponent(cve)}/msrc_details?source={{ b.get('source','') }}&q={{ b.get('q','') }}&severity={{ b.get('severity','') }}&page={{ b.get('page','') }}`);
            const rawBody = await res.text();
            let data;
            try {
                data = JSON.parse(rawBody);
            } catch (parseErr) {
                content.innerHTML = `<div class="text-red-700 font-semibold">Unable to parse response (status ${res.status}).</div><pre class="mt-2 text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2">${rawBody || "(empty response)"}</pre>`;
                return;
            }
            if (!data.ok) {
                content.innerHTML = `<div class="text-red-700 font-semibold">Failed to load details (${res.status}). ${data.error || ""}</div>`;
            } else {
                const insecureNote = data.insecure ? `<div class="mb-2 text-[11px] text-amber-800 bg-amber-50 border border-amber-200 rounded px-2 py-1">Fetched from Microsoft with SSL verification disabled due to certificate issues.</div>` : "";
                const rawText = data.raw_text || "";
                if (typeof data.content === "object") {
                    // Extract CVEs
                    const cveSet = new Set();
                    const cveRegex = /CVE-\d{4}-\d{4,7}/gi;
                    const docHtml = typeof data.content?.Document === "string" ? data.content.Document : "";
                    if (Array.isArray(data.content?.Vulnerability)) {
                        data.content.Vulnerability.forEach(v => { if (v && v.CVE) cveSet.add(v.CVE); });
                    }
                    if (Array.isArray(data.content?.CVE)) {
                        data.content.CVE.forEach(c => { if (c) cveSet.add(c); });
                    }
                    if (docHtml) {
                        const matches = docHtml.match(cveRegex);
                        if (matches) {
                            matches.forEach(c => cveSet.add(c));
                        }
                    }
                    const cves = Array.from(cveSet);
                    // Prefer simplified summary from backend; fallback to raw vulnerabilities
                    const summaryRows = Array.isArray(data.summary_vulns) && data.summary_vulns.length
                        ? data.summary_vulns.slice(0, 200).map(v => [
                            v.cve || "—",
                            [v.severity, v.score].filter(Boolean).join(" / ") || "—",
                            v.vector || "—",
                            v.threat || "—",
                            v.description || "—",
                            v.discovery_date || "—",
                            v.release_date || "—",
                            v.cwe || "—",
                            v.products || "—",
                            v.product_names || "—",
                            v.remediations || "—",
                            v.remediation_urls || "—",
                            v.remediation_types || "—",
                            v.acknowledgments || "—",
                            v.revision_history || "—",
                        ])
                        : null;
                    // Build table rows from Document HTML if present
                    let detailTable = docHtml ? pickTable(docHtml) : null;
                    const listSection = (() => {
                        if (!cves.length) return "";
                        const limited = cves.slice(0, 80);
                        const more = cves.length - limited.length;
                        const listHtml = `<ul class="list-disc list-inside text-xs text-slate-700 space-y-0.5">
                                ${limited.map(c => `<li>${c}</li>`).join("")}
                            </ul>
                            ${more > 0 ? `<div class="text-[11px] text-slate-500 mt-1">+${more} more CVEs not shown</div>` : ""}`;
                        return `<details class="mb-2 border border-slate-200 rounded">
                            <summary class="cursor-pointer text-xs font-semibold text-slate-800 px-2 py-1 bg-slate-50">CVEs (${cves.length})</summary>
                            <div class="p-2">${listHtml}</div>
                        </details>`;
                    })();
                    const renderDoc = docHtml ? `<div class="border border-slate-200 rounded mb-2 overflow-auto text-xs">${docHtml}</div>` : "";
                    const tableSection = (() => {
                        // Prefer a vulnerability table if present
                        if (summaryRows || (Array.isArray(data.content?.Vulnerability) && data.content.Vulnerability.length)) {
                            const headers = ["CVE", "Severity / Score", "Vector", "Threat", "Description", "Discovery", "Release", "CWE", "Products", "Product Names", "Remediations", "Remediation URLs", "Remediation Types", "Acknowledgments", "Revision History"];
                            const rows = summaryRows || data.content.Vulnerability.slice(0, 120).map(v => {
                                const clean = (txt) => String(txt || "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
                                const cveVal = v.CVE || v.ID || "—";
                                const toSevLabel = (scoreVal, fallback) => {
                                    if (fallback) return fallback;
                                    const s = typeof scoreVal === "number" ? scoreVal : parseFloat(scoreVal);
                                    if (Number.isFinite(s)) {
                                        if (s >= 9) return "Critical";
                                        if (s >= 7) return "High";
                                        if (s >= 4) return "Medium";
                                        return "Low";
                                    }
                                    return "";
                                };
                                let severity = v.Severity || v.BaseSeverity || "";
                                let score = "";
                                let vector = "";
                                if (Array.isArray(v.CVSSScoreSets) && v.CVSSScoreSets.length) {
                                    const s = v.CVSSScoreSets[0] || {};
                                    score = s.BaseScore ?? s.Score ?? "";
                                    vector = s.Vector || s.VectorString || "";
                                    if (!severity) {
                                        severity = s.BaseSeverity || s.BaseSev || toSevLabel(score, "");
                                    }
                                }
                                const threats = Array.isArray(v.Threats) ? v.Threats : [];
                                let threatText = "";
                                if (!severity && threats.length) {
                                    const sevThreat = threats.find(t => t && (t.Severity || t.Type === 0 || t.Type === 1));
                                    if (sevThreat) {
                                        severity = sevThreat.Severity || severity || "";
                                        if (!score && sevThreat.Score) score = sevThreat.Score;
                                        if (!severity && sevThreat.Description && sevThreat.Description.Value) {
                                            severity = sevThreat.Description.Value;
                                        }
                                    }
                                }
                                if (threats.length && !threatText) {
                                    const tDesc = threats.find(t => t && t.Description && (t.Description.Value || t.Description.Text));
                                    if (tDesc) threatText = tDesc.Description.Value || tDesc.Description.Text || threatText;
                                }
                                severity = severity || toSevLabel(score, "");
                                const severityCell = [severity, score].filter(Boolean).join(" / ") || "—";
                                let desc = "";
                                if (Array.isArray(v.Notes)) {
                                    const note = v.Notes.find(n => {
                                        if (!n) return false;
                                        if (typeof n.Type === "number") return n.Type === 2;
                                        const typeStr = (n.Type ?? "").toString().toLowerCase();
                                        const titleStr = (n.Title ?? "").toString().toLowerCase();
                                        return typeStr === "description" || titleStr === "description";
                                    }) || v.Notes[0];
                                    if (note) desc = note.Text || note.Value || note.Description || note.Title || "";
                                    if (desc && desc.toLowerCase() === "description") desc = "";
                                    if (!desc) {
                                        const anyNote = v.Notes.find(n => n && (n.Text || n.Value || n.Description));
                                        if (anyNote) desc = anyNote.Text || anyNote.Value || anyNote.Description || "";
                                    }
                                }
                                if (!desc && threatText) {
                                    desc = threatText;
                                }
                                if (!desc && Array.isArray(v.CVSSScoreSets) && v.CVSSScoreSets.length) {
                                    const s = v.CVSSScoreSets[0] || {};
                                    desc = s.Vector || s.VectorString || desc;
                                }
                                if (!desc) desc = v.Title || v.ID || "";
                                desc = clean(desc);
                                const discovery = v.DiscoveryDate || "—";
                                const release = v.ReleaseDate || "—";
                                const cwe = v.CWE || "—";
                                const products = (() => {
                                    const ids = [];
                                    const statuses = Array.isArray(v.ProductStatuses) ? v.ProductStatuses : [];
                                    statuses.forEach(st => {
                                        if (st && Array.isArray(st.ProductID)) ids.push(...st.ProductID);
                                    });
                                    const rems = Array.isArray(v.Remediations) ? v.Remediations : [];
                                    rems.forEach(r => {
                                        if (r && Array.isArray(r.ProductID)) ids.push(...r.ProductID);
                                    });
                                    return ids.length ? Array.from(new Set(ids)).join(", ") : "—";
                                })();
                                const remediations = (() => {
                                    const rems = Array.isArray(v.Remediations) ? v.Remediations : [];
                                    if (!rems.length) return "—";
                                    const parts = rems.map(r => {
                                        if (!r) return "";
                                        let desc = r.Description;
                                        if (desc && typeof desc === "object") {
                                            desc = desc.Value || desc.Text || "";
                                        }
                                        const url = r.URL || "";
                                        const label = r.Name || r.Title || "";
                                        return [label, desc, url].filter(Boolean).join(" | ");
                                    }).filter(Boolean);
                                    return parts.length ? parts.join("; ") : "—";
                                })();
                                return [cveVal, severityCell, vector || "—", clean(threatText) || "—", desc || "—", discovery, release, cwe, products, remediations];
                            });
                            const head = headers.map(h => `<th class="px-2 py-1 text-left">${h}</th>`).join("");
                            const body = rows.map(r => `<tr class="border-t border-slate-100">${r.map(c => `<td class="px-2 py-1 align-top">${c}</td>`).join("")}</tr>`).join("");
                            return `<div class="border border-slate-200 rounded mb-2 overflow-x-auto">
                                <table class="min-w-full text-xs text-slate-700">
                                    <thead class="bg-slate-100"><tr>${head}</tr></thead>
                                    <tbody>${body}</tbody>
                                </table>
                            </div>`;
                        }
                        if (!detailTable || !detailTable.rows.length) {
                            return renderDoc;
                        }
                        let headers = (detailTable.headers && detailTable.headers.length)
                            ? detailTable.headers
                            : [];
                        if (!headers.length && detailTable.rows.length) {
                            headers = detailTable.rows[0];
                        }
                        const bodyRows = headers === detailTable.rows[0] ? detailTable.rows.slice(1) : detailTable.rows;
                        const head = headers.map(h => `<th class="px-2 py-1 text-left">${h}</th>`).join("");
                        const body = bodyRows.slice(0, 120).map(r => `<tr class="border-t border-slate-100">${r.map(c => `<td class="px-2 py-1">${c}</td>`).join("")}</tr>`).join("");
                        return `<div class="border border-slate-200 rounded mb-2 overflow-x-auto">
                            <table class="min-w-full text-xs text-slate-700">
                                ${head ? `<thead class="bg-slate-100"><tr>${head}</tr></thead>` : ""}
                                <tbody>${body}</tbody>
                            </table>
                        </div>`;
                    })();
                    const kvSection = (() => {
                        const rows = [];
                        for (const [k, v] of Object.entries(data.content || {})) {
                            if (k === "Document") continue;
                            let val = v;
                            if (typeof v === "object") {
                                val = `<pre class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2">${JSON.stringify(v, null, 2)}</pre>`;
                            } else {
                                val = String(v);
                            }
                            rows.push(`<div class="grid grid-cols-[1fr,2fr] gap-2 border-b border-slate-100 py-1">
                                <div class="text-slate-700 font-semibold text-xs">${k}</div>
                                <div class="text-slate-700 text-xs">${val}</div>
                            </div>`);
                        }
                        return rows.join("");
                    })();
                    const rawBlock = docHtml ? `<div class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2 mt-2">${docHtml}</div>` : "";
                    const jsonBlock = `<pre class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2 mt-2">${JSON.stringify(data.content, null, 2)}</pre>`;
                    const rawFallback = rawText ? `<div class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2 mt-2">${rawText}</div>` : "";
                    const docMetaSection = (() => {
                        const esc = (s) => String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        if (!data.content || typeof data.content !== "object") return "";
                        const docTitle = esc(data.content.DocumentTitle?.Value || data.content.DocumentTitle || "");
                        const docType = esc(data.content.DocumentType?.Value || data.content.DocumentType || "");
                        const tracking = data.content.DocumentTracking || {};
                        const ident = tracking.Identification || {};
                        const publisher = data.content.DocumentPublisher || {};
                        const notes = Array.isArray(data.content.DocumentNotes) ? data.content.DocumentNotes : [];
                        const summaryRows = [];
                        if (docTitle) summaryRows.push(`<div><span class="font-semibold">Title:</span> ${docTitle}</div>`);
                        if (docType) summaryRows.push(`<div><span class="font-semibold">Type:</span> ${docType}</div>`);
                        if (ident.ID?.Value || ident.Alias?.Value) {
                            summaryRows.push(`<div><span class="font-semibold">ID/Alias:</span> ${esc(ident.ID?.Value || "")} ${esc(ident.Alias?.Value || "")}</div>`);
                        }
                        if (tracking.Version || tracking.Status) {
                            summaryRows.push(`<div><span class="font-semibold">Version/Status:</span> ${esc(tracking.Version || "")} / ${esc(tracking.Status || "")}</div>`);
                        }
                        if (publisher.ContactDetails?.Value) {
                            summaryRows.push(`<div><span class="font-semibold">Publisher Contact:</span> ${esc(publisher.ContactDetails.Value)}</div>`);
                        }
                        const notesBlock = notes.length ? `<details class="mt-1"><summary class="cursor-pointer text-xs font-semibold text-slate-800">Document Notes (${notes.length})</summary><div class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2 mt-1">${esc(JSON.stringify(notes, null, 2))}</div></details>` : "";
                        const productTreeBlock = data.content.ProductTree ? `<details class="mt-1"><summary class="cursor-pointer text-xs font-semibold text-slate-800">Product Tree</summary><div class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2 mt-1">${esc(JSON.stringify(data.content.ProductTree, null, 2))}</div></details>` : "";
                        return `<div class="border border-slate-200 rounded p-2 mb-2 bg-slate-50">
                            <div class="text-xs font-semibold text-slate-800 mb-1">Document Metadata</div>
                            ${summaryRows.join("") || "<div class='text-xs text-slate-600'>No metadata</div>"}
                            ${notesBlock}
                            ${productTreeBlock}
                        </div>`;
                    })();
                    const fullEntriesSection = (() => {
                        const esc = (s) => String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const vulns = Array.isArray(data.content?.Vulnerability) ? data.content.Vulnerability : [];
                        if (!vulns.length) return "";
                        const cards = vulns.map((v, idx) => {
                            const title = esc(v.CVE || v.ID || `Vulnerability ${idx + 1}`);
                            const sev = esc(v.Severity || v.BaseSeverity || "");
                            const score = esc((v.CVSSScoreSets && v.CVSSScoreSets[0] && (v.CVSSScoreSets[0].BaseScore || v.CVSSScoreSets[0].Score)) || "");
                            const json = esc(JSON.stringify(v, null, 2));
                            return `<details class="border border-slate-200 rounded mb-2">
                                <summary class="cursor-pointer text-xs font-semibold text-slate-800 px-2 py-1 bg-slate-50">${title}${sev || score ? ` · ${[sev, score].filter(Boolean).join(" / ")}` : ""}</summary>
                                <pre class="text-[11px] whitespace-pre-wrap bg-slate-50 border-t border-slate-200 p-2 overflow-x-auto">${json}</pre>
                            </details>`;
                        }).join("");
                        return `<div class="mt-3">
                            <div class="text-xs font-semibold text-slate-800 mb-1">Full Vulnerability Entries (${vulns.length})</div>
                            ${cards}
                        </div>`;
                    })();
                    content.innerHTML = insecureNote + docMetaSection + (tableSection || renderDoc || "") + (listSection || "") + (kvSection || "") + fullEntriesSection + rawBlock + jsonBlock + rawFallback || "<div class='text-slate-600'>No content returned.</div>";
                } else {
                    const txt = data.content || "";
                    const cveRegex = /CVE-\d{4}-\d{4,7}/gi;
                    const picked = txt ? pickTable(txt) : null;
                    const detailRows = picked ? [picked.headers, ...picked.rows] : [];
                    const found = txt.match(cveRegex) || [];
                    const unique = Array.from(new Set(found));
                    const limited = unique.slice(0, 200);
                    const more = unique.length - limited.length;
                    const tableHtml = detailRows.length ? `
                        <div class="border border-slate-200 rounded mb-2 overflow-x-auto">
                            <table class="min-w-full text-xs text-slate-700">
                                ${detailRows[0] ? `<thead class="bg-slate-100"><tr>${detailRows[0].map(h => `<th class="px-2 py-1 text-left">${h}</th>`).join("")}</tr></thead>` : ""}
                                <tbody>
                                    ${detailRows.slice(1, 60).map(r => `<tr class="border-t border-slate-100">${r.map(c => `<td class="px-2 py-1">${c}</td>`).join("")}</tr>`).join("")}
                                </tbody>
                            </table>
                        </div>` : "";
                    const listHtml = limited.length ? `
                        <div class="mb-2">
                            <div class="text-xs font-semibold text-slate-800">CVEs (${unique.length})</div>
                            <ul class="list-disc list-inside text-xs text-slate-700 space-y-0.5">
                                ${limited.map(c => `<li>${c}</li>`).join("")}
                            </ul>
                            ${more > 0 ? `<div class="text-[11px] text-slate-500 mt-1">+${more} more CVEs not shown</div>` : ""}
                        </div>` : "";
                    content.innerHTML = insecureNote + (listHtml || tableHtml || "") + `<div class="text-[11px] whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded p-2">${txt}</div>`;
                }
            }
        } catch (err) {
            console.error("MSRC fetch error", err);
            const msg = (err && err.message) ? err.message : String(err);
            content.innerHTML = `<div class='text-red-700 font-semibold'>Error fetching details: ${msg}</div>`;
        }
    });
    closeBtn?.addEventListener("click", hide);
    modal?.addEventListener("click", (e) => {
        if (e.target === modal) hide();
    });
})();
</script>
{% endif %}
{% endblock %}
