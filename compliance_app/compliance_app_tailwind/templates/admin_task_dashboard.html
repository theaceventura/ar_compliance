{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 space-y-3 md:space-y-0">
    <div class="flex flex-col">
        <h2 class="text-xl font-semibold">
            Company Task Dashboard
            {% if companies %}
                {% if selected_company_id %}
                    - {{ (companies | selectattr('id','equalto', selected_company_id) | list | first).name if (companies | selectattr('id','equalto', selected_company_id) | list) else '' }}
                {% elif is_company_admin and companies[0] %}
                    - {{ companies[0].name }}
                {% endif %}
            {% endif %}
        </h2>
        <div class="text-sm text-slate-500 mt-1">Logged in as {{ user.username }}</div>
    </div>
    {% if not is_company_admin %}
    <form method="GET" class="flex items-center space-x-2 text-sm">
        <label for="companySelect" class="text-slate-700">Company:</label>
        <select id="companySelect" name="company_id" class="border rounded px-2 py-1">
            <option value="all" {% if selected_company_id is none %}selected{% endif %}>All companies</option>
            {% for c in companies %}
                <option value="{{ c.id }}" {% if selected_company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
        <button class="bg-blue-600 text-white px-3 py-1 rounded">Apply</button>
    </form>
    {% else %}
    <div class="flex items-center space-x-3">
        <a href="/dashboard?view=personal" class="text-blue-600 text-sm hover:underline">View my tasks</a>
    </div>
    {% endif %}
</div>

<div class="bg-white shadow rounded relative" data-widget-id="admin-dashboard-metrics">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700">Task Metrics</div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4">
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Total tasks</div>
            <div class="text-2xl">{{ summary.total_tasks }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Completed</div>
            <div class="text-2xl text-green-600">{{ summary.total_completed }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Pending</div>
            <div class="text-2xl text-amber-600">{{ summary.total_pending }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Compliance</div>
            <div class="text-2xl">{{ compliance_percent }}%</div>
        </div>
    </div>
</div>

<div class="bg-white shadow rounded relative mt-8" data-widget-id="admin-dashboard-charts">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700">Charts</div>
    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">Severity distribution</h3>
                <canvas id="severityChart" height="200"></canvas>
            </div>
            <div class="bg-slate-50 border border-slate-100 p-4 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">Impact distribution</h3>
                <canvas id="impactChart" height="200"></canvas>
            </div>
            <div class="bg-slate-50 border border-slate-100 p-4 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">Completion distribution (Overview Tasks)</h3>
                <canvas id="completionChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="mt-6 bg-white shadow rounded relative" data-widget-id="admin-dashboard-users">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700">User Metrics</div>
    <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Total Users</div>
            <div class="text-2xl font-semibold">{{ user_metrics.total_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Users Completed All Tasks</div>
            <div class="text-2xl font-semibold text-green-700">{{ user_metrics.completed_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500">Users Pending/Overdue</div>
            <div class="text-2xl font-semibold text-amber-700">{{ user_metrics.pending_users }}</div>
            {% if user_metrics.overdue_users > 0 %}
                <div class="mt-1 text-xs text-red-700 font-semibold">Overdue: {{ user_metrics.overdue_users }}</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="mt-8 bg-white shadow rounded relative" data-widget-id="admin-dashboard-user-status">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <h3 class="text-lg">User Completion Status</h3>
        <div class="space-x-3 text-sm">
            <a href="/admin/report/summary.csv" class="text-blue-600 hover:underline">Download summary CSV</a>
            <a href="/admin/notify/overdue" class="text-blue-600 hover:underline">Send overdue notifications</a>
            <a href="/admin/users" class="text-blue-600 hover:underline">User Admin</a>
        </div>
    </div>
    <div class="p-4 space-y-2 text-sm">
        <div class="grid grid-cols-[1fr,120px,160px,120px,120px] gap-2 items-center bg-slate-100 px-3 py-2 rounded font-semibold text-slate-700">
            <div class="text-left">Username</div>
            <div class="text-center">Role</div>
            <div class="text-center">Completed / Total</div>
            <div class="text-center">Compliance</div>
            <div class="text-center">Report</div>
        </div>
        <div class="flex items-center space-x-4 text-xs text-slate-600 px-1">
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded border border-amber-200 bg-amber-50 inline-block"></span>
                <span>Pending tasks remain</span>
            </span>
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded border border-slate-200 bg-slate-50 inline-block"></span>
                <span>All tasks completed</span>
            </span>
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded bg-red-600 inline-block"></span>
                <span>Overdue count badge</span>
            </span>
        </div>
        {% for row in compliance %}
            {% set total = row.total_tasks or 0 %}
            {% set completed = row.completed_tasks or 0 %}
            {% set pending = row.pending_tasks or (total - completed) %}
            {% set pct = (completed / total * 100) if total else 0 %}
            {% set overdue = row.overdue_tasks or 0 %}
            {% set base_bg = 'bg-slate-50' if loop.index0 % 2 == 0 else 'bg-slate-100/60' %}
            <div class="grid grid-cols-[1fr,120px,160px,120px,120px] gap-2 items-center px-3 py-2 rounded {% if pending > 0 %}bg-amber-50 border border-amber-200{% else %}{{ base_bg }}{% endif %}">
                <div class="text-left truncate">{{ row.username }}</div>
                <div class="text-center">{{ row.role }}</div>
                <div class="text-center">{{ completed }} / {{ total }}</div>
                <div class="text-center">{{ pct|round(1) }}%</div>
                <div class="text-center">
                    {% if overdue > 0 %}
                        <div class="text-xs text-red-700 font-semibold mb-1">Overdue: {{ overdue }}</div>
                    {% endif %}
                    {% if is_company_admin %}
                        <a href="/company-admin/report/{{ row.id }}" class="text-blue-600 hover:underline">View</a>
                    {% else %}
                        <a href="/admin/report/{{ row.id }}" class="text-blue-600 hover:underline">View</a>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const severityData = {{ severity_counts|map(attribute='count')|list|tojson }};
    const severityLabels = {{ severity_counts|map(attribute='label')|list|tojson }};
    const impactData = {{ impact_counts|map(attribute='count')|list|tojson }};
    const impactLabels = {{ impact_counts|map(attribute='label')|list|tojson }};
    const completionData = [{{ summary.total_completed }}, {{ pending_non_overdue }}, {{ summary.total_overdue }}];
    const completionLabels = ["Completed", "Pending", "Overdue"];

    const palette = ['#2563eb','#16a34a','#f59e0b','#ef4444','#8b5cf6','#0ea5e9'];

    function makePie(ctxId, labels, data, colors) {
        const ctx = document.getElementById(ctxId);
        if (!ctx) return;
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors && colors.length ? colors : labels.map((_, i) => palette[i % palette.length]),
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    makePie('severityChart', severityLabels, severityData, {{ severity_palette|tojson }});
    makePie('impactChart', impactLabels, impactData, {{ impact_palette|tojson }});
    makePie('completionChart', completionLabels, completionData, {{ completion_palette|tojson }});
</script>
{% endblock %}
