{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 space-y-3 md:space-y-0">
    <div class="flex flex-col">
        <h2 class="text-xl font-semibold">
            <span data-label-id="title-company-task-dashboard">Company Task Dashboard</span>
            {% if companies %}
                {% if selected_company_id %}
                    - {{ (companies | selectattr('id','equalto', selected_company_id) | list | first).name if (companies | selectattr('id','equalto', selected_company_id) | list) else '' }}
                {% elif is_company_admin and companies[0] %}
                    - {{ companies[0].name }}
                {% endif %}
            {% endif %}
        </h2>
    </div>
    {% if not is_company_admin %}
    <form id="company-filter-form" method="GET" class="flex items-center space-x-2 text-sm">
        <label for="companySelect" class="text-slate-700">Company:</label>
        <select id="companySelect" name="company_id" class="border rounded px-2 py-1">
            <option value="all" {% if selected_company_id is none %}selected{% endif %}>All companies</option>
            {% for c in companies %}
                <option value="{{ c.id }}" {% if selected_company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </form>
    {% else %}
    <div class="flex items-center space-x-3">
        <a href="/dashboard?view=personal" class="text-blue-600 text-sm hover:underline">View my tasks</a>
    </div>
    {% endif %}
</div>

<div class="bg-white shadow rounded relative mb-4" data-widget-id="admin-dashboard-metrics">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <span data-label-id="heading-task-metrics">
            {% if metric_mode == 'user' %}User Metrics{% else %}Task Metrics{% endif %}
        </span>
        <div class="flex items-center space-x-2 text-xs text-slate-600">
            <span>Mode:</span>
            <a href="?metric_mode=task" class="px-2 py-1 rounded border {{ 'bg-blue-600 text-white border-blue-600' if metric_mode=='task' else 'border-slate-200' }}">Tasks</a>
            <a href="?metric_mode=user" class="px-2 py-1 rounded border {{ 'bg-blue-600 text-white border-blue-600' if metric_mode=='user' else 'border-slate-200' }}">Users</a>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 p-2">
        <button type="button" data-metric-target="charts" class="bg-slate-50 border border-slate-100 p-3 rounded text-center hover:border-blue-300 hover:shadow focus:outline-none focus:ring" data-summary="all">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-task-total" data-label-id="label-task-total">Total Tasks</span>
            </div>
            <div class="text-2xl font-semibold">
                {% if metric_mode == 'user' %}
                    {{ user_counts.total }}
                {% else %}
                    {{ task_counts.total }}
                {% endif %}
            </div>
            {% if metric_mode == 'task' %}
            <div class="text-xs text-slate-500">Assignments: {{ assignment_counts.total }}</div>
            {% endif %}
        </button>
        <button type="button" data-metric-target="completion-card" class="bg-slate-50 border border-slate-100 p-3 rounded text-center hover:border-blue-300 hover:shadow focus:outline-none focus:ring" data-summary="completed">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-task-completed" data-label-id="label-task-completed">Completed</span>
            </div>
            <div class="text-2xl font-semibold text-green-700">
                {% if metric_mode == 'user' %}
                    {{ user_counts.completed }} / {{ user_counts.total }}
                {% else %}
                    {{ task_counts.completed }} / {{ task_counts.total }}
                {% endif %}
            </div>
            {% if metric_mode == 'task' %}
            <div class="text-xs text-green-700">Assignments: {{ assignment_counts.completed }} / {{ assignment_counts.total }}</div>
            {% endif %}
        </button>
        <button type="button" data-metric-target="completion-card" class="bg-slate-50 border border-slate-100 p-3 rounded text-center hover:border-blue-300 hover:shadow focus:outline-none focus:ring" data-summary="pending">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-task-pending" data-label-id="label-task-pending">Pending</span>
            </div>
            <div class="text-2xl font-semibold text-amber-700">
                {% if metric_mode == 'user' %}
                    {{ user_counts.pending }} / {{ user_counts.total }}
                {% else %}
                    {{ task_counts.pending }} / {{ task_counts.total }}
                {% endif %}
            </div>
            {% if metric_mode == 'task' %}
            <div class="text-xs text-amber-700">Assignments: {{ assignment_counts.pending }} / {{ assignment_counts.total }}</div>
            {% endif %}
        </button>
        <button type="button" data-metric-target="completion-card" class="bg-slate-50 border border-slate-100 p-3 rounded text-center hover:border-blue-300 hover:shadow focus:outline-none focus:ring" data-summary="overdue">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-task-overdue" data-label-id="label-task-overdue">Overdue</span>
            </div>
            <div class="text-2xl font-semibold text-red-700">
                {% if metric_mode == 'user' %}
                    {{ user_counts.overdue }} / {{ user_counts.total }}
                {% else %}
                    {{ task_counts.overdue }} / {{ task_counts.total }}
                {% endif %}
            </div>
            {% if metric_mode == 'task' %}
            <div class="text-xs text-red-700">Assignments: {{ assignment_counts.overdue }} / {{ assignment_counts.total }}</div>
            {% endif %}
        </button>
        <button type="button" data-metric-target="user-status" class="bg-slate-50 border border-slate-100 p-3 rounded text-center hover:border-blue-300 hover:shadow focus:outline-none focus:ring" data-summary="all">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-task-compliance" data-label-id="label-task-compliance">Compliance</span>
            </div>
            <div class="text-2xl font-semibold text-emerald-700">
                {% if metric_mode == 'user' %}
                    {{ user_counts.compliance }}%
                {% else %}
                    {{ compliance_percent }}%
                {% endif %}
            </div>
        </button>
    </div>
    <div class="px-3 pb-3">
        <div class="bg-slate-50 border border-slate-100 rounded p-2 text-xs text-slate-600">
            Task metrics are task-based: Completed counts tasks where every assigned user finished; Pending is total minus completed; Overdue counts tasks past due; Compliance is completed tasks divided by total tasks.
        </div>
        {% if unassigned_tasks %}
        <div class="bg-amber-50 border border-amber-200 text-amber-800 rounded p-2 text-xs mt-2 flex items-center justify-between">
            <span>No user assigned to {{ unassigned_tasks }} task{% if unassigned_tasks != 1 %}s{% endif %} (excluded from metrics). Assign users to include them.</span>
            <button type="button" id="view-unassigned" class="underline text-amber-800 hover:text-amber-900">View</button>
        </div>
        {% endif %}
    </div>
</div>

<div class="bg-white shadow rounded relative mb-4" data-widget-id="admin-dashboard-company-table">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700">Company Task Summary</div>
    <div class="p-3 space-y-2 text-sm">
        <div class="text-xs text-slate-500">Companies loaded: {{ company_table_rows|length }}</div>
        {% if company_table_rows and company_table_rows|length > 0 %}
            <div class="text-xs text-slate-500">Loaded companies: {{ company_table_rows | map(attribute='name') | list | join(', ') }}</div>
        {% endif %}
        <div class="tbl-header text-sm grid grid-cols-[2.5fr,0.65fr,0.9fr,0.9fr,0.9fr,0.9fr,0.9fr,1.15fr] gap-2 items-center">
            <div class="text-left">Company</div>
            <div class="text-center">Users</div>
            <div class="text-center">Total</div>
            <div class="text-center">Assignments</div>
            <div class="text-center">Completed</div>
            <div class="text-center">Pending</div>
            <div class="text-center">Overdue</div>
            <div class="text-center">Compliance %</div>
        </div>
        {% for row in company_table_rows %}
            {% set warn = row.unassigned and row.unassigned > 0 %}
            {% set is_selected = selected_company_id is not none and row.company_id == selected_company_id %}
            {% set base_class = 'tbl-row text-sm grid grid-cols-[2.5fr,0.65fr,0.9fr,0.9fr,0.9fr,0.9fr,0.9fr,1.15fr] gap-2 items-center cursor-pointer' %}
            {% set status_class = '' %}
            {% if row.tasks_overdue > 0 %}
                {% set status_class = 'bg-red-50 border border-red-200' %}
            {% elif row.tasks_pending > 0 %}
                {% set status_class = 'bg-amber-50 border border-amber-200' %}
            {% else %}
                {% set status_class = 'bg-green-50 border border-green-200' %}
            {% endif %}
            {% set alt_class = 'tbl-row-alt' if loop.index0 % 2 == 1 else '' %}
            {% set highlight_class = 'ring-2 ring-blue-300' if is_selected else '' %}
            {% set row_class = base_class ~ ' ' ~ alt_class ~ ' ' ~ status_class ~ ' ' ~ highlight_class %}
            <div class="{{ row_class }}" data-company-row data-company-id="{{ row.company_id }}">
                <div class="text-left font-semibold text-slate-800 text-blue-700 break-words whitespace-normal">
                    {{ row.name }}
                </div>
                <div class="text-center font-semibold text-slate-800">{{ row.user_count }}</div>
                <div class="text-center">{{ row.tasks_total }}</div>
                <div class="text-center">{{ row.assignments_total or 0 }}</div>
                <div class="text-center text-green-700">{{ row.tasks_completed }}</div>
                <div class="text-center text-amber-700">{{ row.tasks_pending }}</div>
                <div class="text-center text-red-700">{{ row.tasks_overdue }}</div>
                <div class="text-center text-emerald-700 font-semibold">{{ row.tasks_compliance }}%</div>
            </div>
            {% set users_for_company = company_user_rows.get(row.company_id) or company_user_rows.get(row.company_id|string) or [] %}
            <div id="company-users-{{ row.company_id }}" class="hidden border border-slate-200 rounded px-3 py-2 bg-slate-50 text-sm space-y-1">
                {% if users_for_company and users_for_company|length > 0 %}
                    <div class="tbl-header text-xs grid grid-cols-[1.4fr,1fr,1fr,1fr,1fr,0.9fr] gap-2 items-center">
                        <div class="text-left">User</div>
                        <div class="text-center">Completed/Total</div>
                        <div class="text-center">Pending</div>
                        <div class="text-center">Overdue</div>
                        <div class="text-center">Status</div>
                        <div class="text-center">Tasks</div>
                    </div>
                    {% for u in users_for_company %}
                        {% set total = u.total_tasks or 0 %}
                        {% set completed = u.completed_tasks or 0 %}
                        {% set pending = (u.pending_tasks or (total - completed)) %}
                        {% set overdue = u.overdue_tasks or 0 %}
                        {% set row_class = loop.index0 % 2 == 1 and 'tbl-row-alt' or '' %}
                        {% if overdue > 0 %}
                            {% set row_class = row_class ~ ' bg-red-50 border border-red-200' %}
                        {% elif pending > 0 %}
                            {% set row_class = row_class ~ ' bg-amber-50 border border-amber-200' %}
                        {% else %}
                            {% set row_class = row_class ~ ' bg-green-50 border border-green-200' %}
                        {% endif %}
                        <div class="tbl-row text-xs grid grid-cols-[1.4fr,1fr,1fr,1fr,1fr,0.9fr] gap-2 items-center {{ row_class }}">
                            <div class="text-left truncate">{{ u.first_name or '' }} {{ u.last_name or '' }} ({{ u.username }})</div>
                            <div class="text-center text-green-700">{{ completed }}/{{ total }}</div>
                            <div class="text-center text-amber-700">{{ pending }}</div>
                            <div class="text-center text-red-700">{{ overdue }}</div>
                            <div class="text-center">
                                {% if overdue > 0 %}
                                    <span class="text-red-700 font-semibold">Overdue</span>
                                {% elif pending > 0 %}
                                    <span class="text-amber-700 font-semibold">Pending</span>
                                {% else %}
                                    <span class="text-green-700 font-semibold">Complete</span>
                                {% endif %}
                            </div>
                            <div class="text-center">
                                {% if user.role == 'company_admin' %}
                                    <a href="{{ url_for('company_admin_report', user_id=u.id) }}" class="text-blue-600 hover:underline">View Tasks</a>
                                {% else %}
                                    <a href="{{ url_for('admin_report', user_id=u.id) }}" class="text-blue-600 hover:underline">View Tasks</a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-xs text-slate-600">No users.</div>
                {% endif %}
            </div>
        {% endfor %}
        {% if company_table_rows|length == 0 %}
            <div class="tbl-empty text-sm">No companies to display.</div>
        {% endif %}
        {% if company_totals %}
            <div class="tbl-row text-sm grid grid-cols-[2.5fr,0.65fr,0.9fr,0.9fr,0.9fr,0.9fr,0.9fr,1.15fr] gap-2 items-center bg-slate-200 font-semibold text-slate-900">
                <div class="text-left">Total</div>
                <div class="text-center">{{ company_totals.user_count }}</div>
                <div class="text-center">{{ company_totals.tasks_total }}</div>
                <div class="text-center">{{ company_totals.assignments_total or 0 }}</div>
                <div class="text-center text-green-700">{{ company_totals.tasks_completed }}</div>
                <div class="text-center text-amber-700">{{ company_totals.tasks_pending }}</div>
                <div class="text-center text-red-700">{{ company_totals.tasks_overdue }}</div>
                <div class="text-center text-emerald-700">{{ company_totals.tasks_compliance }}%</div>
            </div>
        {% endif %}
        {% set warn_rows = company_summaries|selectattr('unassigned','gt',0)|list %}
        {% if warn_rows|length > 0 %}
            <div class="mt-2 bg-amber-50 border border-amber-200 text-amber-800 rounded px-3 py-2 text-xs space-y-1">
                {% for row in warn_rows %}
                    <div class="flex items-center justify-between">
                        <span>No user assigned to {{ row.unassigned }} task{% if row.unassigned != 1 %}s{% endif %} for {{ row.name }} (excluded from metrics).</span>
                        <button type="button" class="underline text-amber-800 hover:text-amber-900" onclick="document.getElementById('company-users-{{ row.company_id }}')?.classList.remove('hidden')">View</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

{% set show_charts = (app_settings.show_task_charts if app_settings is not none else 1) %}
{% set show_matrix = (app_settings.show_risk_matrix if app_settings is not none else 1) %}

{% if show_charts %}
<div class="bg-white shadow rounded relative mt-4" data-widget-id="admin-dashboard-charts">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700"><span data-label-id="heading-charts">Task Risk Charts</span></div>
    <div class="p-3">
        <div id="charts" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div id="severity-card" class="bg-slate-50 border border-slate-100 p-3 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3"><span data-label-id="chart-task-severity">Task Severity</span></h3>
                {% if severity_counts %}
                    <div class="flex justify-center">
                        <canvas id="severityChart" width="180" height="180"></canvas>
                    </div>
                {% else %}
                    <div class="text-center text-xs text-slate-500 py-8">No severity data to chart.</div>
                {% endif %}
            </div>
            <div id="impact-card" class="bg-slate-50 border border-slate-100 p-3 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3"><span data-label-id="chart-task-impact">Task Impact</span></h3>
                {% if impact_counts %}
                    <div class="flex justify-center">
                        <canvas id="impactChart" width="180" height="180"></canvas>
                    </div>
                {% else %}
                    <div class="text-center text-xs text-slate-500 py-8">No impact data to chart.</div>
                {% endif %}
            </div>
            <div id="completion-card" class="bg-slate-50 border border-slate-100 p-3 rounded">
                <h3 class="text-sm font-semibold text-slate-700 mb-3"><span data-label-id="chart-task-completion">Task Completion</span></h3>
                {% if task_counts.total > 0 %}
                    <div class="flex justify-center">
                        <canvas id="completionChart" width="180" height="180"></canvas>
                    </div>
                {% else %}
                    <div class="text-center text-xs text-slate-500 py-8">No tasks to chart.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if show_matrix %}
<div class="mt-4 bg-white shadow rounded relative" data-widget-id="admin-dashboard-risk-matrix">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <span data-label-id="heading-risk-matrix">Task Risk Matrix (Severity × Impact)</span>
    </div>
    <div class="p-3 overflow-x-auto">
        <style>
            .risk-low { background: #d1fae5; }
            .risk-med { background: #fef9c3; }
            .risk-high { background: #fee2e2; }
            .risk-cell { border: 1px solid #e2e8f0; }
        </style>
        {% if risk_matrix.severity_labels and risk_matrix.impact_labels %}
            <div class="flex flex-col space-y-3">
                <div class="flex items-center text-sm font-semibold text-slate-700 mb-1">
                    <span class="inline-block" style="width:140px;"></span>
                    <span data-label-id="risk-impact-label">Impact →</span>
                </div>
                <table class="min-w-full text-sm text-slate-700 border border-slate-100">
                    <colgroup>
                        <col style="width:140px;">
                    </colgroup>
                    <thead class="tbl-header text-sm">
                        <tr>
                            <th class="px-3 py-2 text-center border-b border-slate-100"><span data-label-id="risk-severity-label">Severity ↓</span></th>
                            {% for imp in risk_matrix.impact_labels %}
                                <th class="px-3 py-2 text-center border-b border-l border-slate-100"><span data-label-id="risk-impact-{{ loop.index0 }}">{{ imp }}</span></th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for sev in risk_matrix.severity_labels %}
                            {% set sev_idx = loop.index0 %}
                            <tr class="tbl-row text-sm {% if loop.index0 % 2 == 1 %}tbl-row-alt{% endif %}">
                                <td class="px-3 py-2 font-semibold border-t border-slate-100 text-center"><span data-label-id="risk-severity-{{ loop.index0 }}">{{ sev }}</span></td>
                            {% for imp in risk_matrix.impact_labels %}
                                {% set sev_score = risk_matrix.severity_ranks.get(sev, 0) %}
                                {% set imp_score = risk_matrix.impact_ranks.get(imp, 0) %}
                                {% set score = sev_score + imp_score %}
                                {% set tier = 'risk-low' %}
                                {% if score >= 4 %}
                                    {% set tier = 'risk-high' %}
                                {% elif score >= 2 %}
                                    {% set tier = 'risk-med' %}
                                {% endif %}
                                    <td class="px-3 py-2 text-center border-t border-l border-slate-100 risk-cell {{ tier }} cursor-pointer hover:ring-2 hover:ring-blue-300"
                                        data-risk-cell
                                        data-severity="{{ sev }}"
                                        data-impact="{{ imp }}">
                                        <div class="font-semibold">{{ risk_matrix.counts[sev][imp] }}</div>
                                        <div class="text-xs text-slate-600">
                                            {% if tier == 'risk-high' %}<span data-label-id="risk-cell-high">High</span>{% elif tier == 'risk-med' %}<span data-label-id="risk-cell-medium">Medium</span>{% else %}<span data-label-id="risk-cell-low">Low</span>{% endif %}
                                        </div>
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="flex items-center space-x-3 text-xs text-slate-600 mt-3">
                <span class="inline-flex items-center space-x-1"><span class="w-3 h-3 rounded risk-high inline-block"></span><span data-label-id="risk-legend-high">High</span></span>
                <span class="inline-flex items-center space-x-1"><span class="w-3 h-3 rounded risk-med inline-block"></span><span data-label-id="risk-legend-medium">Medium</span></span>
                <span class="inline-flex items-center space-x-1"><span class="w-3 h-3 rounded risk-low inline-block"></span><span data-label-id="risk-legend-low">Low</span></span>
            </div>
        {% else %}
            <div class="text-sm text-slate-500">No tasks available to build a risk matrix.</div>
        {% endif %}
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function filterUsers(list, f) {
    let title;
    let out = list || [];
    if (typeof f === 'string') {
        if (f === 'completed') {
            out = out.filter(u => (u.pending_tasks || 0) === 0 && (u.total_tasks || 0) > 0);
            title = 'Users Complete';
        } else if (f === 'pending') {
            out = out.filter(u => (u.pending_tasks || 0) > 0);
            title = 'Users Pending';
        } else if (f === 'overdue') {
            out = out.filter(u => (u.overdue_tasks || 0) > 0);
            title = 'Users Overdue';
        } else {
            title = 'All Users';
        }
    } else {
        title = 'All Users';
    }
    return { list: out, title };
}

function filterTasks(list, f) {
    let title = 'Task Summary';
    let out = list || [];
    if (typeof f === 'string') {
        if (f === 'completed') {
            out = out.filter(t => t.fully_completed);
            title = 'Completed Tasks';
        } else if (f === 'pending') {
            out = out.filter(t => !t.fully_completed);
            title = 'Pending Tasks';
        } else if (f === 'overdue') {
            out = out.filter(t => t.overdue);
            title = 'Overdue Tasks';
        } else if (f === 'unassigned') {
            // build unassigned list from the provided task list to avoid relying on an external variable
            out = out.filter(t => (t.assign_total || 0) === 0);
            title = 'Unassigned Tasks';
        } else {
            title = 'All Tasks';
        }
    } else if (f && f.type === 'risk') {
        const sev = f.severity || 'Unspecified';
        const imp = f.impact || 'Unspecified';
        out = out.filter(t => (t.severity || 'Unspecified') === sev && (t.impact || 'Unspecified') === imp);
        title = 'Tasks: ' + sev + ' / ' + imp;
    }
    return { list: out, title };
}

document.addEventListener('DOMContentLoaded', () => {
    // Smooth scroll/highlight helper for cards when clicking tiles
    const highlightCard = (id) => {
        document.querySelectorAll('.ring-highlight').forEach(el => el.classList.remove('ring-highlight'));
        if (!id) return;
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('ring-highlight');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    const severityData = {{ severity_counts|map(attribute='count')|list|tojson }};
    const severityLabels = {{ severity_counts|map(attribute='label')|list|tojson }};
    const impactData = {{ impact_counts|map(attribute='count')|list|tojson }};
    const impactLabels = {{ impact_counts|map(attribute='label')|list|tojson }};
    const completionData = {{ [task_counts.completed, task_counts.pending, task_counts.overdue]|tojson }};
    const completionLabels = ["Completed", "Pending", "Overdue"];
    const metricMode = "{{ metric_mode }}";
    const allTasks = {{ tasks|tojson }};
    const allUsers = {{ compliance|tojson }};
    const modal = document.getElementById('task-modal');
    const modalContent = document.getElementById('task-modal-content');
    const modalTitle = document.getElementById('task-modal-title');
    const modalClose = document.getElementById('task-modal-close');

    const palette = ['#2563eb','#16a34a','#f59e0b','#ef4444','#8b5cf6','#0ea5e9'];

    // Simple inline label editor (non-persistent) when enabled
    document.querySelectorAll('[data-label-target]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const targetId = btn.dataset.labelTarget;
            const span = document.getElementById(targetId);
            if (!span) return;
            const current = span.textContent.trim();
            const next = prompt('Edit label text:', current);
            if (next !== null && next.trim() !== '') {
                span.textContent = next.trim();
            }
        });
    });

    function makePie(ctxId, labels, data, colors) {
        const ctx = document.getElementById(ctxId);
        if (!ctx) return;
        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors && colors.length ? colors : labels.map((_, i) => palette[i % palette.length]),
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
        return chart;
    }

    // Parse palette JSON safely so template markers don't break JS parsing before rendering
    const severityPalette = {{ severity_palette|default([])|tojson }};
    const impactPalette = {{ impact_palette|default([])|tojson }};
    const completionPalette = {{ completion_palette|default([])|tojson }};

    makePie('severityChart', severityLabels, severityData, severityPalette);
    makePie('impactChart', impactLabels, impactData, impactPalette);
    makePie('completionChart', completionLabels, completionData, completionPalette);
    // filterUsers moved to outer scope — use the implementation defined above
    
            // Move renderUserModal to outer DOMContentLoaded scope so it is not nested inside showTasks.
            function renderUserModal(list, titleText) {
                if (!modal || !modalContent) return;
                modalContent.innerHTML = '';
                if (modalTitle) modalTitle.textContent = titleText;
                const scrollWrap = document.createElement('div');
                scrollWrap.className = 'overflow-x-auto';
                const wrapper = document.createElement('div');
                wrapper.className = 'space-y-2 text-sm min-w-[620px]';
                const header = document.createElement('div');
                header.className = 'grid grid-cols-[220px,120px,90px,90px,120px] gap-2 items-center bg-slate-100 px-3 py-2 rounded font-semibold text-slate-700 text-center';
                header.innerHTML = `
                    <div class="text-left">User</div>
                    <div class="text-center">Completed / Total</div>
                    <div class="text-center">Pending</div>
                    <div class="text-center">Overdue</div>
                    <div class="text-center">Status</div>
                `;
                wrapper.appendChild(header);
                if (list.length) {
                    let sumTotal = 0, sumCompleted = 0, sumPending = 0, sumOverdue = 0;
                    let completeUsers = 0;
                    list.forEach((u, idx) => {
                        const total = u.total_tasks || 0;
                        const completed = u.completed_tasks || 0;
                        const pending = u.pending_tasks == null ? Math.max(total - completed, 0) : u.pending_tasks;
                        const overdue = u.overdue_tasks || 0;
                        sumTotal += total;
                        sumCompleted += completed;
                        sumPending += pending;
                        sumOverdue += overdue;
                        if (pending === 0) completeUsers += 1;
                        const row = document.createElement('div');
                        const base = idx % 2 === 0 ? 'bg-slate-50' : 'bg-slate-100/60';
                        row.className = `grid grid-cols-[220px,120px,90px,90px,120px] gap-2 items-center px-3 py-2 rounded text-center ${base}`;
                        let statusHtml;
                        if (overdue > 0) {
                            statusHtml = '<span class="text-red-700 font-semibold">Overdue</span>';
                        } else if (pending > 0) {
                            statusHtml = '<span class="text-amber-700 font-semibold">Pending</span>';
                        } else if (total > 0) {
                            statusHtml = '<span class="text-green-700 font-semibold">Complete</span>';
                        }
                        if (!statusHtml) {
                            statusHtml = '<span class="text-slate-700">No tasks</span>';
                        }
                        const displayName = `${u.first_name || ''} ${u.last_name || ''}`.trim() || u.username || 'User';
                        row.innerHTML = `
                            <div class="text-left text-sm font-semibold text-slate-900 truncate">${displayName} (${u.username || ''})</div>
                            <div class="text-center text-green-700">${completed}/${total}</div>
                            <div class="text-center text-amber-700">${pending}</div>
                            <div class="text-center text-red-700">${overdue}</div>
                            <div class="text-center">${statusHtml}</div>
                        `;
                        wrapper.appendChild(row);
                    });
                } else {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-slate-600 px-3 py-2';
                    p.innerHTML = '<span data-label-id="modal-empty">No users found for this category.</span>';
                    wrapper.appendChild(p);
                }
                scrollWrap.appendChild(wrapper);
                modalContent.appendChild(scrollWrap);
            }
    
            // Removed duplicate/broken renderTaskModal implementation that referenced undefined variables;
            // the proper renderTaskModal is defined below.

            // Helper: render a list of tasks into the modal
            function renderTaskModal(list, titleText) {
                if (!modal || !modalContent) return;
                modalContent.innerHTML = '';
                if (modalTitle) modalTitle.textContent = titleText;
                const scrollWrap = document.createElement('div');
                scrollWrap.className = 'overflow-x-auto';
                const wrapper = document.createElement('div');
                wrapper.className = 'space-y-2 text-sm min-w-[590px]';
                const header = document.createElement('div');
                header.className = 'grid grid-cols-[240px,120px,90px,140px,100px] gap-2 items-center bg-slate-100 px-3 py-2 rounded font-semibold text-slate-700 text-center';
                header.innerHTML = `
                    <div class="text-left"><span data-label-id="modal-col-task">Task</span></div>
                    <div class="text-center"><span data-label-id="modal-col-type">Task Type</span></div>
                    <div class="text-center"><span data-label-id="modal-col-percent">% Complete</span></div>
                    <div class="text-center"><span data-label-id="modal-col-users">No. Users Assigned</span></div>
                    <div class="text-center"><span data-label-id="modal-col-status">Status</span></div>
                `;
                wrapper.appendChild(header);
                if (list.length) {
                    let totalAssignSum = 0, totalDoneSum = 0, completedTasks = 0, overdueTasks = 0;
                    list.forEach((t, idx) => {
                        const base = idx % 2 === 0 ? 'bg-slate-50' : 'bg-slate-100/60';
                        const row = document.createElement('div');
                        const overdue = t.overdue ? 'bg-red-50 border border-red-200' : base;
                        row.className = `grid grid-cols-[240px,120px,90px,140px,100px] gap-2 items-center px-3 py-2 rounded text-center ${overdue}`;
                        const totalAssign = t.assign_total || 0;
                        const done = t.assign_completed || 0;
                        const pct = t.completion_pct || 0;
                        totalAssignSum += totalAssign;
                        totalDoneSum += done;
                        if (t.fully_completed) completedTasks += 1;
                        if (t.overdue) overdueTasks += 1;
                        let flag;
                        if (t.overdue) {
                            flag = '<span class="text-red-700 font-semibold" data-label-id="modal-flag-overdue">Overdue</span>';
                        } else if (t.fully_completed) {
                            flag = '<span class="text-green-700 font-semibold" data-label-id="modal-flag-completed">Completed</span>';
                        } else {
                            flag = '<span class="text-amber-700 font-semibold" data-label-id="modal-flag-pending">Pending</span>';
                        }
                        const companyLabel = t.company_label ? t.company_label : 'Global';
                        const companyDisplay = (companyLabel && companyLabel.toLowerCase() === 'global')
                            ? '<span class="font-semibold">Global</span>'
                            : companyLabel;
                        row.innerHTML = `
                            <div class="text-left text-sm font-semibold text-slate-900 truncate">${t.title || 'Untitled'}</div>
                            <div class="text-center text-xs text-slate-700">${companyDisplay}</div>
                            <div class="text-center text-xs text-slate-700">${pct}%</div>
                            <div class="text-center text-xs text-slate-700">${done}/${totalAssign || 0}</div>
                            <div class="text-center text-xs">${flag}</div>
                        `;
                        wrapper.appendChild(row);
                    });
                    const totalTasks = list.length;
                    const avgPct = totalTasks ? Math.round((list.reduce((s, t) => s + (t.completion_pct || 0), 0) / totalTasks) * 10) / 10 : 0;
                    const totalsRow = document.createElement('div');
                    totalsRow.className = 'grid grid-cols-[240px,120px,90px,140px,100px] gap-2 items-center px-3 py-2 rounded bg-slate-200 text-sm font-semibold text-slate-800 text-center';
                    totalsRow.innerHTML = `
                        <div class="text-left">Totals</div>
                        <div class="text-center">${totalTasks} tasks</div>
                        <div>${avgPct}% avg</div>
                        <div>${totalDoneSum}/${totalAssignSum}</div>
                        <div>${completedTasks}/${totalTasks} complete</div>
                    `;
                    wrapper.appendChild(totalsRow);
                } else {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-slate-600 px-3 py-2';
                    p.innerHTML = '<span data-label-id="modal-empty">No tasks found for this category.</span>';
                    wrapper.appendChild(p);
                }
                scrollWrap.appendChild(wrapper);
                modalContent.appendChild(scrollWrap);
            }

        // Main dispatcher
        function showTasks(filter) {
            if (metricMode === 'user') {
                if (!modal || !modalContent) return;
                const users = allUsers || [];
                const filtered = filterUsers(users, filter);
                renderUserModal(filtered.list, filtered.title);
                modal.classList.remove('hidden');
                return;
            }

            if (!modal || !modalContent) return;
            const tasks = allTasks || [];
            const filteredTasks = filterTasks(tasks, filter);
            renderTaskModal(filteredTasks.list, filteredTasks.title);
            modal.classList.remove('hidden');
        }
    document.querySelectorAll('[data-metric-target]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const target = btn.dataset.metricTarget;
            highlightCard(target);
            const summaryFilter = btn.dataset.summary || 'all';
            if (target === 'completion-card' && summaryFilter === 'pending') {
                showTasks('pending');
            } else {
                showTasks(summaryFilter);
            }
        });
    });
    // Risk matrix cell clicks -> show tasks for that severity/impact
    document.querySelectorAll('[data-risk-cell]').forEach(cell => {
        cell.addEventListener('click', () => {
            const sev = cell.dataset.severity;
            const imp = cell.dataset.impact;
            showTasks({ type: 'risk', severity: sev, impact: imp });
        });
    });
    if (modalClose) {
        modalClose.addEventListener('click', () => modal.classList.add('hidden'));
    }
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.add('hidden');
    });
    // Unassigned tasks popup
    const unassignedBtn = document.getElementById('view-unassigned');
    const unassignedFooterBtn = document.getElementById('view-unassigned-footer');
    // Auto-submit company filter on change
    const companySelect = document.getElementById('companySelect');
    const companyForm = document.getElementById('company-filter-form');
    if (companySelect && companyForm) {
        companySelect.addEventListener('change', () => companyForm.submit());
    }
    const bindUnassigned = (btn) => {
        if (!btn) return;
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            showTasks('unassigned');
        });
    };
    bindUnassigned(unassignedBtn);
    bindUnassigned(unassignedFooterBtn);

    // Auto-expand company users panel when expand_company query param is present
    const params = new URLSearchParams(window.location.search);
    const expandCompany = params.get('expand_company');
    if (expandCompany) {
        const panel = document.getElementById(`company-users-${expandCompany}`);
        if (panel) {
            panel.classList.remove('hidden');
        }
    }

    // Company row expand/collapse
    document.querySelectorAll('[data-company-row]').forEach(row => {
        row.addEventListener('click', () => {
            const cid = row.dataset.companyId;
            if (!cid) return;
            const panel = document.getElementById(`company-users-${cid}`);
            if (panel) {
                panel.classList.toggle('hidden');
            }
        });
    });
});
</script>

<style>
    .ring-highlight { box-shadow: 0 0 0 3px rgba(59,130,246,0.4); transition: box-shadow 0.3s ease; }
</style>

<div id="task-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center">
    <div class="bg-white rounded shadow-lg max-w-3xl w-11/12 md:w-3/4">
        <div class="flex items-center justify-between px-4 py-2 border-b">
            <h4 id="task-modal-title" class="font-semibold text-slate-800"><span data-label-id="modal-task-summary-title">Task Summary</span></h4>
            <button id="task-modal-close" class="text-slate-500 hover:text-slate-700">&times;</button>
        </div>
        <div id="task-modal-content" class="p-4 max-h-[60vh] overflow-y-auto space-y-2 text-sm text-slate-700"></div>
    </div>
</div>
{% endblock %}
