<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .widget-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 10px;
            padding: 2px 4px;
            background: #e2e8f0;
            color: #1e293b;
            border-radius: 3px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            cursor: pointer;
            z-index: 20;
        }
        .label-edit-link {
            font-size: 10px;
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 6px;
            white-space: nowrap;
        }
        .tbl-header {
            background: #f1f5f9;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            color: #0f172a;
        }
        .tbl-row {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
        }
        .tbl-row-alt {
            background: #f8fafc;
        }
        .tbl-row-bg {
            background: #f1f5f9;
        }
        .tbl-empty {
            padding: 0.5rem 0.75rem;
            color: #64748b;
        }
    </style>
    {% block extra_styles %}{% endblock %}
</head>
<body class="bg-slate-100">
    <nav class="bg-white shadow mb-6">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex flex-col">
                {% set app_title = (app_settings.app_name if app_settings else None) or 'Compliance Tracker' %}
                <a href="/" class="font-semibold hover:underline">{{ app_title }}</a>
                {% if app_settings.show_user_banner and current_user_banner %}
                    <span class="text-[10px] text-slate-600 leading-tight">
                        Logged in User: {{ current_user_banner.display_name }} ({{ current_user_banner.role_label }})
                    </span>
                {% endif %}
            </div>
            <div class="flex items-center space-x-4 text-sm">
                {% set username = session.get('username') %}
                {% set role = session.get('role') %}
                {% if username and role %}
                    <a href="/" class="hover:underline"><span data-label-id="nav-home">Home</span></a>

                    {# Global Admin menus #}
                    {% if role == 'admin' %}
                        <div class="relative inline-block" data-menu>
                            <button type="button" class="hover:underline" data-menu-button><span data-label-id="nav-tasks">Tasks ▾</span></button>
                            <div class="hidden absolute right-0 mt-2 w-48 bg-white border shadow-lg rounded z-10" data-menu-dropdown>
                                <a href="/dashboard" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-task-dashboard">Task Dashboard</span></a>
                            </div>
                        </div>
                        <div class="relative inline-block" data-menu>
                            <button type="button" class="hover:underline" data-menu-button><span data-label-id="nav-admin">Admin ▾</span></button>
                            <div class="hidden absolute right-0 mt-2 w-48 bg-white border shadow-lg rounded z-10" data-menu-dropdown>
                                <a href="/admin/dashboard" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-admin-dashboard">Admin Dashboard</span></a>
                                <a href="/admin/companies" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-company-config">Company Admin</span></a>
                                <a href="/admin/users" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-user-config">User Admin</span></a>
                                <a href="/admin/tasks" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-task-admin">Task Admin</span></a>
                                <a href="/admin/risk-config" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-risk-matrix-admin">Risk Matrix Admin</span></a>
                                <a href="/admin/app" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-app-config">App Config</span></a>
                            </div>
                        </div>
                        <a href="/admin/profile" class="hover:underline"><span data-label-id="nav-profile">My Profile</span></a>

                    {# Company Admin menus #}
                    {% elif role == 'company_admin' %}
                        <div class="relative inline-block" data-menu>
                            <button type="button" class="hover:underline" data-menu-button><span data-label-id="nav-tasks">Tasks ▾</span></button>
                            <div class="hidden absolute right-0 mt-2 w-52 bg-white border shadow-lg rounded z-10" data-menu-dropdown>
                                <a href="/dashboard?view=personal" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-my-tasks">My Tasks</span></a>
                                <a href="/dashboard" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-company-tasks">Company Tasks</span></a>
                            </div>
                        </div>
                        <div class="relative inline-block" data-menu>
                            <button type="button" class="hover:underline" data-menu-button><span data-label-id="nav-company-admin">Admin ▾</span></button>
                            <div class="hidden absolute right-0 mt-2 w-52 bg-white border shadow-lg rounded z-10" data-menu-dropdown>
                                <a href="/company-admin/users" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-company-users">Company Users</span></a>
                            </div>
                        </div>
                        <a href="/admin/profile" class="hover:underline"><span data-label-id="nav-profile">My Profile</span></a>

                    {# Regular user menus #}
                    {% else %}
                        <div class="relative inline-block" data-menu>
                            <button type="button" class="hover:underline" data-menu-button><span data-label-id="nav-tasks">Tasks ▾</span></button>
                            <div class="hidden absolute right-0 mt-2 w-48 bg-white border shadow-lg rounded z-10" data-menu-dropdown>
                                <a href="/dashboard" class="block px-3 py-2 hover:bg-slate-100"><span data-label-id="nav-my-tasks">My Tasks</span></a>
                            </div>
                        </div>
                        <a href="/admin/profile" class="hover:underline"><span data-label-id="nav-profile">My Profile</span></a>
                    {% endif %}

                    <a href="/logout" class="hover:underline"><span data-label-id="nav-logout">Logout</span></a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        {% with msgs = get_flashed_messages() %}
            {% if msgs %}
                <div class="mb-4">
                    {% for m in msgs %}
                        <div class="bg-green-100 text-green-800 px-3 py-2 rounded mb-2 text-sm">{{ m }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    {% if app_settings %}
        {% if app_settings.show_version or app_settings.show_page_name or app_settings.show_module_tree %}
            <div class="fixed bottom-3 left-0 right-0 flex justify-center pointer-events-none px-4">
                <div class="pointer-events-auto text-xs text-slate-600 bg-white/90 border rounded px-4 py-2 shadow inline-flex flex-col space-y-1">
                    <div class="flex items-center justify-between space-x-4">
                        <div class="flex items-center space-x-4">
                            {% if app_settings.show_version %}<div><span class="font-semibold">Version:</span> {{ app_settings.version }}</div>{% endif %}
                            {% if app_settings.show_page_name %}<div><span class="font-semibold">Page:</span> {{ page_name }}</div>{% endif %}
                        </div>
                        {% if app_settings.show_cut_icon %}
                        <button type="button" id="copyFooterBtn" class="bg-slate-200 text-slate-700 px-2 py-1 rounded text-xs">Copy Page URL</button>
                        {% endif %}
                    </div>
                    {% if app_settings.show_module_tree %}
                    <div class="mt-1">
                        <div class="font-semibold">Modules tree</div>
                        <ul class="list-disc ml-4">
                            <li>app.py
                                <ul class="list-disc ml-4">
                                    {% if app_settings.show_page_name %}<li>{{ page_name }}</li>{% endif %}
                                    <li>db.py</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endif %}

    <script>
        const menus = document.querySelectorAll("[data-menu]");
        menus.forEach(menu => {
            const btn = menu.querySelector("[data-menu-button]");
            const drop = menu.querySelector("[data-menu-dropdown]");
            if (!btn || !drop) return;
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                drop.classList.toggle("hidden");
            });
            drop.addEventListener("click", (e) => e.stopPropagation());
        });
        document.addEventListener("click", () => {
            document.querySelectorAll("[data-menu-dropdown]").forEach(d => d.classList.add("hidden"));
        });

        const copyFooterBtn = document.getElementById("copyFooterBtn");
        if (copyFooterBtn && navigator.clipboard) {
            copyFooterBtn.addEventListener("click", async () => {
                const pageRef = "{{ page_name|default('', true) }}";
                const textToCopy = pageRef || (window.location.pathname + window.location.search + window.location.hash);
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    copyFooterBtn.textContent = "Copied!";
                    setTimeout(() => copyFooterBtn.textContent = "Copy Page URL", 1500);
                } catch (err) {
                    copyFooterBtn.textContent = "Failed";
                    setTimeout(() => copyFooterBtn.textContent = "Copy Page URL", 1500);
                }
            });
        }

        // Add copy buttons to widgets when enabled
        const widgetCopyEnabled = {{ (app_settings.show_cut_icon if app_settings else 0) | int }};
        if (widgetCopyEnabled && navigator.clipboard) {
            const widgets = document.querySelectorAll("[data-widget-id]");
            widgets.forEach(widget => {
                widget.classList.add("relative");
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "widget-copy-btn text-[10px] px-1.5 py-0.5";
                btn.textContent = "CR";
                const ref = widget.getAttribute("data-widget-id") || "";
                btn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    if (!ref) return;
                    try {
                        await navigator.clipboard.writeText(ref);
                        btn.textContent = "Copied";
                        setTimeout(() => btn.textContent = "CR", 1200);
                    } catch {
                        btn.textContent = "Failed";
                        setTimeout(() => btn.textContent = "CR", 1200);
                    }
                });
                widget.appendChild(btn);
            });
        }

        // Label edit helpers (non-persistent) when enabled
        const labelEditEnabled = {{ (app_settings.show_label_edit if app_settings else 0) | int }};
        if (labelEditEnabled) {
            const addLabelEditors = () => {
                // Auto-tag common headings if they don't already have a data-label-id
                const autoTargets = document.querySelectorAll('h1, h2, h3, h4, th, .section-title, .widget-title');
                let autoIdx = 0;
                autoTargets.forEach(el => {
                    if (!el.getAttribute('data-label-id')) {
                        el.setAttribute('data-label-id', `auto-label-${autoIdx++}`);
                    }
                });

                document.querySelectorAll('[data-label-id]').forEach(el => {
                    if (el.dataset.labelEnhanced === '1') return;
                    const edit = document.createElement('span');
                    edit.className = 'label-edit-link';
                    edit.textContent = 'edit';
                    edit.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const current = el.textContent.trim();
                        const next = prompt('Edit label text:', current);
                        if (next !== null && next.trim() !== '') {
                            el.textContent = next.trim();
                        }
                    });
                    el.insertAdjacentElement('afterend', edit);
                    el.dataset.labelEnhanced = '1';
                });
            };
            addLabelEditors();
        }
    </script>
</body>
</html>
