{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 space-y-3 md:space-y-0">
    <div class="flex flex-col">
        <h2 class="text-xl font-semibold">
            <span data-label-id="title-user-dashboard">User Dashboard</span>
            {% if companies %}
                {% if selected_company_id %}
                    - {{ (companies | selectattr('id','equalto', selected_company_id) | list | first).name if (companies | selectattr('id','equalto', selected_company_id) | list) else '' }}
                {% elif is_company_admin and companies[0] %}
                    - {{ companies[0].name }}
                {% endif %}
            {% endif %}
        </h2>
    </div>
    {% if not is_company_admin %}
    <form method="GET" class="flex items-center space-x-2 text-sm" id="company-filter-form">
        <label for="companySelect" class="text-slate-700">Company:</label>
        <select id="companySelect" name="company_id" class="border rounded px-2 py-1">
            <option value="all" {% if selected_company_id is none %}selected{% endif %}>All companies</option>
            {% for c in companies %}
                <option value="{{ c.id }}" {% if selected_company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
        <input type="hidden" name="view" value="users">
    </form>
    {% else %}
    <div class="flex items-center space-x-3">
        <a href="/dashboard?view=personal" class="text-blue-600 text-sm hover:underline">View my tasks</a>
    </div>
    {% endif %}
</div>

<div class="mt-6 bg-white shadow rounded relative" data-widget-id="user-dashboard-metrics">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700"><span data-label-id="heading-user-metrics">User Metrics</span></div>
    <div class="p-4 grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center cursor-pointer" role="button" data-user-filter="all">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-user-total" data-label-id="label-user-total">Total Users</span>
            </div>
            <div class="text-2xl font-semibold">{{ user_metrics.total_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center cursor-pointer" role="button" data-user-filter="complete">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-user-complete" data-label-id="label-user-complete">Complete</span>
            </div>
            <div class="text-2xl font-semibold text-green-700">{{ user_metrics.completed_users }} / {{ user_metrics.total_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center cursor-pointer" role="button" data-user-filter="pending">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-user-pending" data-label-id="label-user-pending">Pending</span>
            </div>
            <div class="text-2xl font-semibold text-amber-700">{{ user_metrics.pending_users }} / {{ user_metrics.total_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center cursor-pointer" role="button" data-user-filter="overdue">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-user-overdue" data-label-id="label-user-overdue">Overdue</span>
            </div>
            <div class="text-2xl font-semibold text-red-700">{{ user_metrics.overdue_users }} / {{ user_metrics.total_users }}</div>
        </div>
        <div class="bg-slate-50 border border-slate-100 p-4 rounded text-center">
            <div class="text-sm text-slate-500 flex items-center justify-center gap-1">
                <span id="label-user-compliance" data-label-id="label-user-compliance">Compliance %</span>
            </div>
            <div class="text-2xl font-semibold text-emerald-700">{{ user_metrics.compliance_pct }}%</div>
        </div>
    </div>
    <div class="px-4 pb-4">
        <div class="bg-slate-50 border border-slate-100 rounded p-3 text-sm text-slate-600">
            User metrics are user-based: Complete counts users with no pending tasks; Pending counts users with any unfinished tasks; Overdue counts users who have overdue tasks; Compliance is complete users divided by total users.
        </div>
    </div>
</div>

<div id="user-status" class="mt-8 bg-white shadow rounded relative" data-widget-id="user-dashboard-user-status">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <h3 class="text-lg"><span data-label-id="heading-user-status">User Completion Status</span></h3>
        <div class="space-x-3 text-sm">
            <a href="/admin/report/summary.csv" class="text-blue-600 hover:underline">Download summary CSV</a>
            <a href="/admin/notify/overdue" class="text-blue-600 hover:underline">Send overdue notifications</a>
            <a href="/admin/users" class="text-blue-600 hover:underline">User Admin</a>
        </div>
    </div>
        <div class="p-3 space-y-2 text-sm">
            <div class="tbl-header text-sm grid grid-cols-[200px,160px,120px,120px,120px] gap-2 items-center">
                <div class="text-left"><span data-label-id="user-table-name">Name</span></div>
                <div class="text-left"><span data-label-id="user-table-username">Username</span></div>
                <div class="text-center"><span data-label-id="user-table-role">Role</span></div>
            <div class="text-center"><span data-label-id="user-table-completed">Completed / Total</span></div>
            <div class="text-center"><span data-label-id="user-table-status">Status</span></div>
        </div>
        {% if compliance %}
        <div id="user-rows" class="space-y-1">
        {% for row in compliance %}
            {% set total = row.total_tasks or 0 %}
            {% set completed = row.completed_tasks or 0 %}
            {% set pending = row.pending_tasks or (total - completed) %}
            {% set pct = (completed / total * 100) if total else 0 %}
            {% set overdue = row.overdue_tasks or 0 %}
            {% set row_class = 'bg-green-50 border border-green-200' %}
            {% if overdue > 0 %}
                {% set row_class = 'bg-red-50 border border-red-200' %}
            {% elif pending > 0 %}
                {% set row_class = 'bg-amber-50 border border-amber-200' %}
            {% endif %}
            <div class="user-status-row tbl-row text-sm grid grid-cols-[200px,160px,120px,120px,120px] gap-2 items-center rounded {{ row_class }}" data-pending="{{ pending }}" data-overdue="{{ overdue }}" data-user-row data-user-id="{{ row.id }}">
                <div class="text-left truncate flex items-center gap-2">
                    <span class="inline-block transition-transform duration-150 text-slate-500" data-user-arrow="{{ row.id }}">▶</span>
                    <span class="truncate">{{ row.first_name or '' }} {{ row.last_name or '' }}</span>
                </div>
                <div class="text-left truncate">{{ row.username }}</div>
                <div class="text-center">{{ role_label(row.role) }}</div>
                <div class="text-center">{{ completed }} / {{ total }}</div>
                <div class="text-center">
                    {% if overdue > 0 %}
                        <span class="text-red-700 font-semibold">Overdue</span>
                        <span class="text-xs text-slate-600">({{ overdue }})</span>
                    {% elif pending > 0 %}
                        <span class="text-amber-700 font-semibold">Pending</span>
                        <span class="text-xs text-slate-600">
                            (<span class="text-amber-700">{{ pending }}</span>{% if overdue > 0 %}/<span class="text-red-700">{{ overdue }}</span>{% endif %})
                        </span>
                    {% else %}
                        <span class="text-green-700 font-semibold">Complete</span>
                        <span class="text-xs text-slate-600">({{ completed }})</span>
                    {% endif %}
                </div>
            </div>
            {% set tasks = user_tasks_map.get(row.id, []) %}
            <div id="user-tasks-{{ row.id }}" class="hidden border border-slate-200 rounded px-3 py-2 bg-slate-50 text-xs text-slate-700 space-y-2">
                {% if tasks %}
                    <div class="tbl-header text-[11px] grid grid-cols-[2fr,1fr,1fr,1fr,0.9fr] gap-2 items-center">
                        <div class="text-left">Task</div>
                        <div class="text-center">Type</div>
                        <div class="text-center">Status</div>
                        <div class="text-center">Due</div>
                        <div class="text-center">Open</div>
                    </div>
                    {% for t in tasks %}
                        {% set row_cls = 'bg-green-50 border border-green-200' %}
                        {% if t.overdue_flag %}
                            {% set row_cls = 'bg-red-50 border border-red-200' %}
                        {% elif t.status != 'completed' %}
                            {% set row_cls = 'bg-amber-50 border border-amber-200' %}
                        {% endif %}
                        <div class="tbl-row grid grid-cols-[2fr,1fr,1fr,1fr,0.9fr] gap-2 items-center rounded {{ row_cls }}">
                            <div class="text-left truncate">{{ t.title }}</div>
                            <div class="text-center">{{ 'Global' if t.company_id is none else 'Company' }}</div>
                            <div class="text-center">
                                {% if t.status == 'completed' %}
                                    <span class="text-green-700 font-semibold">Completed</span>
                                {% elif t.overdue_flag %}
                                    <span class="text-red-700 font-semibold">Overdue</span>
                                {% else %}
                                    <span class="text-amber-700 font-semibold">Pending</span>
                                {% endif %}
                            </div>
                            <div class="text-center">{{ t.due_display or '—' }}</div>
                            <div class="text-center">
                                <a href="{{ url_for('task_detail', task_id=t.id) }}" class="text-blue-600 hover:underline">View</a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-slate-600">No tasks for this user.</div>
                {% endif %}
                <div class="flex items-center justify-between pt-1">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>Completed: <span class="font-semibold">{{ completed }}</span> / {{ total }}</div>
                        <div>Pending: <span class="font-semibold text-amber-700">{{ pending }}</span></div>
                        <div>Overdue: <span class="font-semibold text-red-700">{{ overdue }}</span></div>
                    </div>
                    <div>
                        {% if is_company_admin %}
                            <a href="/company-admin/report/{{ row.id }}" class="text-blue-600 hover:underline">View Tasks</a>
                        {% else %}
                            <a href="/admin/report/{{ row.id }}" class="text-blue-600 hover:underline">View Tasks</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
        <div class="flex items-center justify-between text-xs text-slate-600 mt-2">
            <div id="user-table-status"></div>
            <div class="space-x-2">
                <button type="button" id="user-table-show-more" class="px-2 py-1 border rounded bg-white hover:bg-slate-50">Show more</button>
                <button type="button" id="user-table-show-all" class="px-2 py-1 border rounded bg-white hover:bg-slate-50">Show all</button>
            </div>
        </div>
        {% else %}
            <div class="tbl-empty text-sm">No users to display.</div>
        {% endif %}
        <div class="flex items-center space-x-4 text-xs text-slate-600 px-1 pt-2">
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded border border-amber-200 bg-amber-50 inline-block"></span>
                <span data-label-id="legend-pending">Pending tasks remain</span>
            </span>
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded border border-slate-200 bg-slate-50 inline-block"></span>
                <span data-label-id="legend-complete">All tasks completed</span>
            </span>
            <span class="inline-flex items-center space-x-1">
                <span class="w-3 h-3 rounded bg-red-600 inline-block"></span>
                <span data-label-id="legend-overdue">Overdue count badge</span>
            </span>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    // Auto-submit company filter on change
    const companySelect = document.getElementById('companySelect');
    const companyForm = document.getElementById('company-filter-form');
    if (companySelect && companyForm) {
        companySelect.addEventListener('change', () => companyForm.submit());
    }
    // User metric filters -> filter table rows
    const metricButtons = document.querySelectorAll('[data-user-filter]');
    const userRows = Array.from(document.querySelectorAll('.user-status-row'));
    const statusSection = document.getElementById('user-status');
    const defaultLimit = 5;
    let currentLimit = defaultLimit;

    function applyLimit(limit) {
        let visibleCount = 0;
        userRows.forEach(row => {
            if (!row.classList.contains('filtered-out')) {
                row.classList.toggle('hidden', visibleCount >= limit);
                if (!row.classList.contains('hidden')) visibleCount += 1;
            } else {
                row.classList.add('hidden');
            }
        });
        const status = document.getElementById('user-table-status');
        if (status) {
            const showing = Math.min(visibleCount, limit);
            status.textContent = `Showing up to ${showing} of ${userRows.length}`;
        }
    }

    // Initial limit
    applyLimit(currentLimit);

    const showMoreBtn = document.getElementById('user-table-show-more');
    const showAllBtn = document.getElementById('user-table-show-all');
    if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
            currentLimit += defaultLimit;
            applyLimit(currentLimit);
        });
    }
    if (showAllBtn) {
        showAllBtn.addEventListener('click', () => {
            currentLimit = userRows.length;
            applyLimit(currentLimit);
        });
    }

    function applyUserFilter(mode) {
        userRows.forEach((row) => {
            const pending = parseInt(row.dataset.pending || '0', 10);
            const overdue = parseInt(row.dataset.overdue || '0', 10);
            let show = true;
            if (mode === 'complete') {
                show = pending === 0 && overdue === 0;
            } else if (mode === 'pending') {
                show = pending > 0;
            } else if (mode === 'overdue') {
                show = overdue > 0;
            }
            row.classList.toggle('filtered-out', !show);
        });
        currentLimit = defaultLimit;
        applyLimit(currentLimit);
        statusSection?.scrollIntoView({ behavior: 'smooth' });
    }
    metricButtons.forEach(btn => {
        btn.addEventListener('click', () => applyUserFilter(btn.dataset.userFilter || 'all'));
    });

    // User row expand/collapse
    const setUserArrow = (uid, expanded) => {
        const arrow = document.querySelector(`[data-user-arrow="${uid}"]`);
        if (!arrow) return;
        arrow.style.transform = expanded ? 'rotate(90deg)' : 'rotate(0deg)';
    };
    document.querySelectorAll('[data-user-row]').forEach(row => {
        row.addEventListener('click', () => {
            const uid = row.dataset.userId;
            if (!uid) return;
            const panel = document.getElementById(`user-tasks-${uid}`);
            if (panel) {
                const willShow = panel.classList.contains('hidden');
                panel.classList.toggle('hidden');
                setUserArrow(uid, willShow);
            }
        });
    });

    document.querySelectorAll('[data-label-target]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const targetId = btn.getAttribute('data-label-target');
            const span = document.getElementById(targetId);
            if (!span) return;
            const current = span.textContent.trim();
            const next = prompt('Edit label text:', current);
            if (next !== null && next.trim() !== '') {
                span.textContent = next.trim();
            }
        });
    });
});
</script>
{% endblock %}
