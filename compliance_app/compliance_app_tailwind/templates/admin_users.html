{% extends "base.html" %}

{% block content %}
<h2 class="text-xl font-semibold mb-4">User Config</h2>

<div class="bg-white shadow rounded mb-6 relative overflow-visible" data-widget-id="admin-users-list">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <h3 class="font-semibold">Users</h3>
        <div class="flex items-center space-x-4">
            <label class="inline-flex items-center space-x-2 text-sm text-slate-700">
                <input type="checkbox" id="filterAdmins" data-role-target="company_admin" class="h-4 w-4">
                <span>Show Company Admins only</span>
            </label>
            {% if not is_company_admin %}
            <form method="GET" class="flex items-center space-x-2 text-sm" id="admin-users-filter-form">
                <label for="userCompanyFilter" class="text-slate-700">Company:</label>
                <select id="userCompanyFilter" name="company_id" class="border rounded px-2 py-1">
                    <option value="" {% if not selected_company_id %}selected{% endif %}>All</option>
                    {% for c in companies %}
                        <option value="{{ c.id }}" {% if selected_company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </form>
            {% endif %}
        </div>
    </div>
    <div class="p-4 space-y-2 text-sm">
        <div class="tbl-header text-sm grid grid-cols-[70px,1.2fr,1.1fr,1fr,0.7fr,0.8fr,0.8fr,0.8fr] gap-2 items-center">
            <div class="text-center">ID</div>
            <div class="text-left">Name</div>
            <div class="text-left">Username</div>
            <div class="text-left">Company</div>
            <div class="text-center">Role</div>
            <div class="text-center">Active</div>
            <div class="text-center">Action</div>
            <div class="text-center">Report</div>
        </div>
        {% if users %}
            {% for u in users %}
                {% set tasks_total = user_task_counts.get(u.id, 0) if user_task_counts is defined else 0 %}
                {% set warn = tasks_total == 0 %}
                <div class="user-row grid grid-cols-[70px,1.2fr,1.1fr,1fr,0.7fr,0.8fr,0.8fr,0.8fr] gap-2 items-center tbl-row text-sm {% if loop.index0 % 2 == 0 %}tbl-row-bg{% else %}tbl-row-alt{% endif %} {{ 'bg-amber-50 border border-amber-200' if warn else '' }}" data-role="{{ u.role }}">
                    <div class="text-center text-xs text-slate-600">{{ u.id }}</div>
                    <div class="text-left text-sm text-slate-800 font-semibold truncate">
                        {{ u.first_name }} {{ u.last_name }}
                    </div>
                    <div class="text-left text-sm truncate text-slate-800">
                        {{ u.username or '(no username)' }}
                    </div>
                    <div class="text-left text-xs text-slate-600 truncate">
                        {% if company_lookup %}
                            {{ company_lookup.get(u.company_id) or ('Company #' ~ u.company_id if u.company_id else 'Unassigned') }}
                        {% else %}
                            {{ 'Company #' ~ u.company_id if u.company_id else 'Unassigned' }}
                        {% endif %}
                    </div>
                    <div class="text-center text-sm">{{ role_label(u.role) }}</div>
                    <div class="text-center text-sm">
                        {% if u.is_active %}
                            <span class="text-green-700 font-semibold">Active</span>
                        {% else %}
                            <span class="text-slate-500">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="text-center text-sm">
                        <a href="/admin/users?user_id={{ u.id }}" class="text-blue-600 hover:underline">Edit</a>
                    </div>
                    <div class="text-center text-sm">
                        {% if u.role == "user" %}
                            {% if is_company_admin %}
                                <a href="/company-admin/report/{{ u.id }}" class="text-blue-600 hover:underline text-sm">View Tasks</a>
                            {% else %}
                                <a href="/admin/report/{{ u.id }}" class="text-blue-600 hover:underline text-sm">View Tasks</a>
                            {% endif %}
                        {% else %}
                            <span class="text-slate-400">â€”</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="tbl-empty text-sm">No users found for this filter.</div>
        {% endif %}
        <div id="user-table-controls" class="flex items-center justify-between text-xs text-slate-600 mt-2">
            <div id="user-table-status"></div>
            <div class="space-x-2">
                <button type="button" id="user-table-show-more" class="px-2 py-1 border rounded bg-white hover:bg-slate-50">Show more</button>
                <button type="button" id="user-table-show-all" class="px-2 py-1 border rounded bg-white hover:bg-slate-50">Show all</button>
            </div>
        </div>
        {% if unassigned_users_count and unassigned_users_count > 0 %}
            <div class="mt-2 bg-amber-50 border border-amber-200 text-amber-800 rounded px-3 py-2 text-xs">
                No tasks assigned to {{ unassigned_users_count }} user{% if unassigned_users_count != 1 %}s{% endif %}. Assign tasks to include them in metrics.
            </div>
        {% endif %}
    </div>
</div>

{% if error %}
    <div class="bg-red-100 text-red-800 px-3 py-2 rounded mb-3">{{ error }}</div>
{% endif %}

<div class="bg-white shadow rounded relative" data-widget-id="admin-users-form">
    <div class="bg-slate-100 px-3 py-2 rounded-t font-semibold text-slate-700 flex items-center justify-between">
        <span>{{ selected_user and 'Edit user' or 'Add user' }}</span>
    </div>
    {% if app_settings.show_validation_notes %}
    <div class="px-3 pt-3 text-xs text-slate-600 bg-slate-50 border-b border-slate-200">
        Validation: A user belongs to a single company. When the company changes, tasks from other companies are removed and applicable company/global tasks are assigned. At least one Global Admin must always remain.
    </div>
    {% endif %}
    <form id="user-form" method="POST" class="p-4 space-y-2 text-sm">
            <!-- Autofill guard -->
            <input type="text" style="display:none" autocomplete="off" tabindex="-1" aria-hidden="true">
            <input type="password" style="display:none" autocomplete="off" tabindex="-1" aria-hidden="true">
            {% if selected_user %}
            <input type="hidden" name="user_id" value="{{ selected_user.id }}">
            {% endif %}
            <div class="grid grid-cols-2 gap-3 px-3 py-2 rounded bg-slate-50 items-center">
                            <div class="flex items-center space-x-2">
                                <span class="text-left font-medium w-24">Username</span>
                                <input type="text" name="username" autocomplete="username" value="{{ selected_user.username if selected_user else '' }}" class="w-full border p-2 rounded text-sm" required placeholder="Required">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-left font-medium w-24">Password</span>
                                <input name="password" autocomplete="new-password" type="password" class="w-full border p-2 rounded text-sm" {% if not selected_user %}required{% endif %} placeholder="{% if selected_user %}Leave blank to keep existing{% else %}Required{% endif %}">
                            </div>
                        </div>
            <div class="grid grid-cols-2 gap-3 px-3 py-2 rounded bg-slate-100/60 items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-left font-medium w-24">First name</span>
                    <input type="text" name="first_name" autocomplete="given-name" value="{{ selected_user.first_name if selected_user else '' }}" class="w-full border p-2 rounded text-sm" required placeholder="Required">
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-left font-medium w-24">Last name</span>
                    <input type="text" name="last_name" autocomplete="family-name" value="{{ selected_user.last_name if selected_user else '' }}" class="w-full border p-2 rounded text-sm" required placeholder="Required">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 px-3 py-2 rounded bg-slate-50 items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-left font-medium w-24">Email</span>
                    <input name="email" type="email" autocomplete="email" value="{{ selected_user.email if selected_user else '' }}" class="w-full border p-2 rounded text-sm" required placeholder="Required">
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-left font-medium w-24">Mobile</span>
                    <input name="mobile" type="tel" inputmode="tel" autocomplete="tel" value="{{ selected_user.mobile if selected_user else '' }}" class="w-full border p-2 rounded text-sm">
                </div>
            </div>
        <div class="grid grid-cols-2 gap-3 px-3 py-2 rounded bg-slate-100/60 items-center">
            <div class="flex items-center space-x-2">
                <span class="text-left font-medium w-24">Company</span>
                {% if is_company_admin %}
                    {% set only_company = companies[0] if companies else None %}
                    <input type="hidden" name="company_id" value="{{ only_company.id if only_company }}">
                    <input class="w-full border p-2 rounded text-sm bg-slate-100" value="{{ only_company.name if only_company else 'Unassigned' }}" disabled>
                {% else %}
                    <select name="company_id" class="w-full border p-2 rounded text-sm" required>
                        <option value="" {% if not selected_user or not selected_user.company_id %}selected{% endif %}>-- Select company --</option>
                        {% for c in companies %}
                            <option value="{{ c.id }}" {% if selected_user and selected_user.company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-left font-medium w-20">Role</span>
                <select name="role" class="w-full border p-2 rounded text-sm" required>
                    <option value="" disabled {% if not selected_user or not selected_user.role %}selected{% endif %}>-- Select role --</option>
                    <option value="user" {% if selected_user and selected_user.role == 'user' %}selected{% endif %}>User</option>
                    {% if allow_admin_role %}
                    <option value="admin" {% if selected_user and selected_user.role == 'admin' %}selected{% endif %}>Admin</option>
                    {% endif %}
                    <option value="company_admin" {% if selected_user and selected_user.role == 'company_admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 px-3 py-2 rounded bg-slate-50 items-center">
            <div class="flex items-center space-x-2">
                <label class="inline-flex items-center space-x-2">
                    <span class="text-left font-medium w-28">Send notifications</span>
                    <input name="send_notifications" type="checkbox" class="h-4 w-4" {% if selected_user and selected_user.send_notifications %}checked{% endif %}>
                </label>
            </div>
            <div class="flex items-center space-x-2">
                <label class="inline-flex items-center space-x-2">
                    <span class="text-left font-medium w-16">Active</span>
                    <input name="is_active" type="checkbox" class="h-4 w-4" {% if selected_user and selected_user.is_active %}checked{% endif %} {% if not selected_user %}checked{% endif %}>
                </label>
            </div>
        </div>
        <div class="flex items-center justify-end gap-2 px-3 pt-2">
            <button id="new-user-btn" class="bg-slate-200 text-slate-700 px-4 py-2 rounded text-sm min-w-[100px]" type="button">New User</button>
            <button id="user-submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded min-w-[140px]">{{ selected_user and 'Save' or 'Add User' }}</button>
        </div>
    </form>
</div>

<script>
    const userFilterForm = document.getElementById('admin-users-filter-form');
    const userCompanyFilter = document.getElementById('userCompanyFilter');
    if (userFilterForm && userCompanyFilter) {
        userCompanyFilter.addEventListener('change', () => userFilterForm.submit());
    }

    const form = document.getElementById('user-form');
    const newBtn = document.getElementById('new-user-btn');
    const submitBtn = document.getElementById('user-submit-btn');
    const hasSelectedUser = JSON.parse('{{ (selected_user is not none) | tojson }}');
    if (form && !hasSelectedUser) {
        form.reset();
        // Explicitly clear fields to avoid browser autofill of the current user
        ['username','password','first_name','last_name','email','mobile'].forEach(name => {
            const el = form.querySelector(`[name="${name}"]`);
            if (el) el.value = '';
        });
        const roleSelect = form.querySelector('select[name="role"]');
        if (roleSelect) roleSelect.selectedIndex = 0;
        const companySelect = form.querySelector('select[name="company_id"]');
        if (companySelect) companySelect.selectedIndex = 0;
        const activeBox = form.querySelector('input[name="is_active"]');
        if (activeBox) activeBox.checked = true;
        const notifBox = form.querySelector('input[name="send_notifications"]');
        if (notifBox) notifBox.checked = false;
    }
    if (newBtn) {
        newBtn.addEventListener('click', () => {
            // Reload without user_id to enter Add mode cleanly
            globalThis.location.href = "/admin/users";
        });
    }

    const filterCheckbox = document.getElementById('filterAdmins');
    const rows = document.querySelectorAll('.user-row');
    if (filterCheckbox) {
        const targetRole = filterCheckbox.dataset.roleTarget || 'admin';
        filterCheckbox.addEventListener('change', () => {
            const showAdmins = filterCheckbox.checked;
            rows.forEach(r => {
                const role = r.dataset.role;
                r.style.display = (!showAdmins || role === targetRole) ? '' : 'none';
            });
        });
    }

    // Row limiter: show first 5, allow expanding
    const limit = 5;
    const userRows = Array.from(rows);
    const statusEl = document.getElementById('user-table-status');
    const showMoreBtn = document.getElementById('user-table-show-more');
    const showAllBtn = document.getElementById('user-table-show-all');
    function updateVisibility(showAll=false) {
        userRows.forEach((r, idx) => {
            if (showAll || idx < limit) {
                r.classList.remove('hidden');
            } else {
                r.classList.add('hidden');
            }
        });
        if (statusEl) {
            const visibleCount = showAll ? userRows.length : Math.min(userRows.length, limit);
            statusEl.textContent = `Showing ${visibleCount} of ${userRows.length}`;
        }
    }
    if (userRows.length) {
        updateVisibility(false);
        showMoreBtn?.addEventListener('click', () => updateVisibility(false));
        showAllBtn?.addEventListener('click', () => updateVisibility(true));
    } else if (statusEl) {
        statusEl.textContent = 'No users';
    }
</script>

{% endblock %}
